# Story 2.3: Companion Activities and Journey Experience Design

## Status
Draft

## Story
**As an** experience seeker,  
**I want** complete journey guides showing before/after activities and optimal timing,  
**so that** I can plan full micro-adventures rather than isolated visits and maximize my exploration time.

## Acceptance Criteria

1. Before/after activity suggestions for each place with timing recommendations and walking directions
2. Journey experience pages with step-by-step guides for complete adventures (Airlines Hotel → Bournvita → Banyan tree → Koshy's)
3. Instagram-story-style horizontal scroll interface for journey progression with visual storytelling
4. Optimal timing suggestions based on crowd patterns, lighting, and seasonal considerations
5. Walking route integration showing actual paths between journey stops with estimated timing
6. Mood-based journey categorization (contemplative walks, energetic exploration, social meetups)
7. Weather integration suggesting indoor/outdoor journey alternatives based on current conditions

## Tasks / Subtasks

- [ ] Enhance Companion Activity System (AC: 1)
  - [ ] Expand CompanionActivityCard component with timing and walking directions
  - [ ] Add before/after activity database schema and data management
  - [ ] Implement walking time calculations between activities
  - [ ] Create activity difficulty and timing estimation system
  - [ ] Add visual indicators for activity sequence and flow

- [ ] Create Journey Experience Pages (AC: 2)
  - [ ] Build journey detail pages with step-by-step guides
  - [ ] Create journey database schema with place sequences
  - [ ] Implement journey navigation and progression tracking
  - [ ] Add journey completion indicators and progress tracking
  - [ ] Create journey sharing and bookmark functionality

- [ ] Design Instagram-Style Journey Interface (AC: 3)
  - [ ] Create horizontal scroll journey progression component
  - [ ] Implement visual storytelling with photo-story cards
  - [ ] Add smooth scrolling animations and transitions
  - [ ] Create touch/swipe gestures for mobile navigation
  - [ ] Design progress indicators and journey completion states

- [ ] Implement Optimal Timing System (AC: 4)
  - [ ] Create timing recommendation engine based on crowd patterns
  - [ ] Add lighting condition analysis for photography and ambiance
  - [ ] Integrate seasonal timing considerations
  - [ ] Implement dynamic timing updates based on real-world data
  - [ ] Create timing conflict detection and alternative suggestions

- [ ] Build Walking Route Integration (AC: 5)
  - [ ] Enhance journey route visualization from Story 2.1
  - [ ] Add detailed walking directions between journey stops
  - [ ] Implement route timing estimation with pace considerations
  - [ ] Create offline route caching for mobile use
  - [ ] Add route difficulty indicators and accessibility notes

- [ ] Create Mood-Based Journey Categorization (AC: 6)
  - [ ] Design journey categorization system (contemplative, energetic, social)
  - [ ] Create mood-based filtering and recommendation engine
  - [ ] Implement journey discovery based on user preferences
  - [ ] Add mood indicators and journey atmosphere descriptions
  - [ ] Create personalized journey suggestions based on history

- [ ] Integrate Weather-Aware Journey Planning (AC: 7)
  - [ ] Connect with weather API from Story 1.7 for journey planning
  - [ ] Create indoor/outdoor journey alternative suggestions
  - [ ] Add weather suitability indicators for each journey stop
  - [ ] Implement dynamic journey rerouting based on weather changes
  - [ ] Create weather-aware timing adjustments and recommendations

## Dev Notes

### Previous Story Insights
- **Story 1.2**: Created companion activities foundation in database schema
- **Story 1.7**: Weather integration provides context for journey planning
- **Story 2.1**: Journey route visualization provides foundation for walking routes
- **Story 2.2**: Rich place content provides context for journey storytelling

### Component Architecture Implementation [Source: architecture/frontend-architecture-integration.md]
**Core Component Enhancement:**
- **CompanionActivityCard** - `components/places/CompanionActivityCard.tsx` - Enhanced with timing, weather suitability, and journey integration
- **JourneyRouteVisualization** - `components/map/JourneyRouteVisualization.tsx` - Step-by-step mobile navigation integration

### Journey Data Model Design
```typescript
interface JourneyExperience {
  id: string;
  name: string;
  description: string;
  mood_category: 'contemplative' | 'energetic' | 'social' | 'cultural' | 'culinary';
  duration_minutes: number;
  difficulty_level: 'easy' | 'moderate' | 'challenging';
  weather_suitability: WeatherCondition[];
  optimal_times: TimeWindow[];
  journey_stops: JourneyStop[];
  alternatives: JourneyAlternative[];
}

interface JourneyStop {
  id: string;
  place_id: string;
  order: number;
  duration_minutes: number;
  activities: CompanionActivity[];
  walking_directions: WalkingDirection;
  timing_notes: string;
  photo_opportunities: PhotoOpportunity[];
}

interface CompanionActivity {
  id: string;
  type: 'before' | 'after' | 'during';
  name: string;
  description: string;
  duration_minutes: number;
  timing: 'morning' | 'afternoon' | 'evening' | 'any';
  weather_dependent: boolean;
  crowd_level_preference: 'quiet' | 'moderate' | 'lively';
}

interface WalkingDirection {
  from_coordinates: LatLng;
  to_coordinates: LatLng;
  path: LatLng[];
  distance_meters: number;
  estimated_minutes: number;
  difficulty: 'easy' | 'moderate' | 'challenging';
  accessibility_notes: string;
  landmarks: string[];
}
```

### File Locations for Journey Features
```
apps/web/
├── app/journeys/
│   ├── page.tsx                     # Journey listing page
│   └── [slug]/
│       └── page.tsx                 # Individual journey experience page
├── components/journeys/
│   ├── JourneyExperienceCard.tsx    # Journey preview cards
│   ├── InstagramStoryInterface.tsx  # Horizontal scroll progression
│   ├── JourneyProgressTracker.tsx   # Progress and completion tracking
│   ├── OptimalTimingDisplay.tsx     # Timing recommendations
│   ├── WalkingDirections.tsx        # Step-by-step directions
│   └── MoodBasedFilter.tsx          # Journey categorization
├── components/places/
│   └── EnhancedCompanionActivityCard.tsx # Enhanced with journey integration
├── lib/journeys/
│   ├── timing.ts                    # Optimal timing calculations
│   ├── routing.ts                   # Walking route utilities
│   └── weather-planning.ts          # Weather-aware journey planning
```

### Instagram-Style Interface Implementation
```typescript
const InstagramStoryInterface = ({ journey }: { journey: JourneyExperience }) => {
  const [currentStop, setCurrentStop] = useState(0);
  const containerRef = useRef<HTMLDivElement>(null);

  const scrollToStop = (stopIndex: number) => {
    const container = containerRef.current;
    if (container) {
      const scrollWidth = container.scrollWidth / journey.journey_stops.length;
      container.scrollTo({ 
        left: scrollWidth * stopIndex, 
        behavior: 'smooth' 
      });
    }
    setCurrentStop(stopIndex);
  };

  return (
    <div className="journey-interface">
      {/* Progress indicators */}
      <div className="flex justify-center mb-4">
        {journey.journey_stops.map((_, index) => (
          <div
            key={index}
            className={`w-8 h-1 mx-1 rounded-full transition-colors ${
              index <= currentStop ? 'bg-yellow-400' : 'bg-gray-300'
            }`}
          />
        ))}
      </div>

      {/* Horizontal scroll container */}
      <div
        ref={containerRef}
        className="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide"
        onScroll={(e) => {
          const scrollLeft = e.currentTarget.scrollLeft;
          const containerWidth = e.currentTarget.offsetWidth;
          const newStop = Math.round(scrollLeft / containerWidth);
          setCurrentStop(newStop);
        }}
      >
        {journey.journey_stops.map((stop, index) => (
          <div
            key={stop.id}
            className="flex-shrink-0 w-full snap-center px-4"
          >
            <JourneyStoryCard 
              stop={stop} 
              isActive={index === currentStop}
              journey={journey}
            />
          </div>
        ))}
      </div>

      {/* Navigation buttons */}
      <div className="flex justify-between mt-4">
        <button
          onClick={() => scrollToStop(Math.max(0, currentStop - 1))}
          disabled={currentStop === 0}
          className="px-4 py-2 bg-gray-200 rounded-lg disabled:opacity-50"
        >
          Previous
        </button>
        <button
          onClick={() => scrollToStop(Math.min(journey.journey_stops.length - 1, currentStop + 1))}
          disabled={currentStop === journey.journey_stops.length - 1}
          className="px-4 py-2 bg-yellow-400 rounded-lg disabled:opacity-50"
        >
          Next
        </button>
      </div>
    </div>
  );
};
```

### Enhanced Companion Activity Card
```typescript
const EnhancedCompanionActivityCard = ({ 
  activity, 
  journeyContext,
  weatherData 
}: EnhancedCompanionActivityProps) => {
  const getActivitySuitability = () => {
    if (activity.weather_dependent && weatherData) {
      return weatherData.condition === 'rain' && !activity.indoor_option ? 'not-suitable' : 'suitable';
    }
    return 'suitable';
  };

  const getOptimalTiming = () => {
    const crowdLevel = getCurrentCrowdLevel(activity.timing);
    const lightingCondition = getLightingCondition(activity.timing);
    return { crowdLevel, lightingCondition };
  };

  return (
    <div className="companion-activity-card bg-white rounded-lg shadow-md p-4 mb-4">
      <div className="flex items-start justify-between mb-3">
        <div className="flex items-center">
          <div className={`activity-type-indicator w-3 h-3 rounded-full mr-3 ${
            activity.type === 'before' ? 'bg-blue-400' : 
            activity.type === 'after' ? 'bg-green-400' : 'bg-purple-400'
          }`} />
          <h3 className="font-medium text-lg">{activity.name}</h3>
        </div>
        
        <div className="flex items-center space-x-2">
          <span className="text-sm text-gray-500">{activity.duration_minutes}min</span>
          {activity.weather_dependent && (
            <WeatherSuitabilityBadge suitability={getActivitySuitability()} />
          )}
        </div>
      </div>

      <p className="text-gray-700 mb-4">{activity.description}</p>

      <div className="timing-recommendations bg-gray-50 rounded-lg p-3 mb-4">
        <h4 className="font-medium text-sm mb-2">Optimal Timing</h4>
        <div className="flex items-center space-x-4 text-sm">
          <span className="flex items-center">
            <Clock className="w-4 h-4 mr-1" />
            {activity.timing}
          </span>
          <span className="flex items-center">
            <Users className="w-4 h-4 mr-1" />
            {activity.crowd_level_preference} crowd
          </span>
        </div>
      </div>

      {journeyContext && (
        <WalkingDirections 
          from={journeyContext.previousLocation}
          to={activity.location}
          estimatedTime={activity.walking_time_minutes}
        />
      )}
    </div>
  );
};
```

### Optimal Timing System
```typescript
const OptimalTimingEngine = {
  calculateOptimalTiming: (journey: JourneyExperience, date: Date) => {
    const recommendations: TimingRecommendation[] = [];
    
    journey.journey_stops.forEach((stop, index) => {
      const place = getPlaceById(stop.place_id);
      const crowdData = getCrowdPatterns(place.id, date);
      const lightingData = getLightingConditions(place.coordinates, date);
      const weatherData = getWeatherForecast(place.coordinates, date);
      
      const optimalWindows = findOptimalTimeWindows({
        crowdData,
        lightingData,
        weatherData,
        placePreferences: place.optimal_times,
        journeyFlow: index > 0 ? journey.journey_stops[index - 1] : null
      });
      
      recommendations.push({
        stop_id: stop.id,
        optimal_windows: optimalWindows,
        reasoning: generateTimingReasoning(optimalWindows),
        alternatives: generateAlternatives(optimalWindows)
      });
    });
    
    return recommendations;
  }
};
```

### Weather-Aware Journey Planning [Source: Story 1.7]
```typescript
const WeatherAwareJourneyPlanner = {
  suggestJourneyAlternatives: async (
    journey: JourneyExperience,
    currentWeather: WeatherData
  ) => {
    if (currentWeather.condition === 'rain') {
      return {
        indoor_alternative: await generateIndoorJourney(journey),
        covered_route: await generateCoveredRoute(journey),
        delayed_start: calculateOptimalDelayTime(currentWeather)
      };
    }
    
    if (currentWeather.condition === 'storm') {
      return {
        postpone_recommendation: true,
        alternative_indoor_activities: await getIndoorAlternatives(journey.mood_category),
        reschedule_suggestions: calculateRescheduleOptions()
      };
    }
    
    return {
      proceed_with_adjustments: await generateWeatherAdjustments(journey, currentWeather)
    };
  }
};
```

### Mood-Based Journey System
```typescript
const MoodBasedJourneyEngine = {
  categorizeJourney: (journey: JourneyExperience): MoodCategory => {
    const activities = journey.journey_stops.flatMap(stop => stop.activities);
    const placeTypes = journey.journey_stops.map(stop => getPlaceById(stop.place_id).category);
    
    const moodScore = {
      contemplative: calculateContemplativeScore(activities, placeTypes),
      energetic: calculateEnergeticScore(activities, placeTypes),
      social: calculateSocialScore(activities, placeTypes),
      cultural: calculateCulturalScore(activities, placeTypes),
      culinary: calculateCulinaryScore(activities, placeTypes)
    };
    
    return Object.keys(moodScore).reduce((a, b) => 
      moodScore[a] > moodScore[b] ? a : b
    ) as MoodCategory;
  },
  
  recommendByMood: (userMood: MoodCategory, availableTime: number) => {
    return getJourneysByMood(userMood)
      .filter(journey => journey.duration_minutes <= availableTime)
      .sort((a, b) => calculatePersonalizationScore(b) - calculatePersonalizationScore(a));
  }
};
```

### Performance Optimization for Journey Interface
- **Lazy Loading**: Load journey stops as user progresses
- **Image Preloading**: Preload next story images during current stop
- **Smooth Scrolling**: Hardware-accelerated horizontal scrolling
- **Memory Management**: Dispose of off-screen story content
- **Offline Support**: Cache journey data for offline access

### Integration Dependencies
- **Story 1.2**: Companion activities foundation and place database
- **Story 1.7**: Weather API for journey planning and alternatives
- **Story 2.1**: Journey route visualization and walking paths
- **Story 2.2**: Rich place content for journey storytelling

### Mobile-First Journey Experience
- **Swipe Gestures**: Native-feeling swipe navigation between stops
- **Portrait Optimization**: Story cards optimized for mobile screens
- **Touch Targets**: Large, accessible touch targets for navigation
- **Offline Mode**: Journey data cached for areas with poor connectivity
- **Battery Optimization**: Efficient location tracking during journeys

### Accessibility Considerations [Source: architecture/coding-standards.md]
- **Screen Readers**: Full journey description and navigation support
- **Keyboard Navigation**: Complete keyboard navigation through journey interface
- **Motion Preferences**: Respect user motion preferences for animations
- **Focus Management**: Logical focus order through journey progression
- **Alternative Navigation**: Non-swipe navigation options for accessibility

## Testing

### Testing Framework [Source: architecture/testing-infrastructure.md]
- **Component Tests**: Journey interface, companion activities, and timing systems
- **E2E Tests**: Complete journey experience flow from discovery to completion
- **Performance Tests**: Horizontal scrolling performance and image loading
- **Integration Tests**: Weather integration and timing calculations

### Test File Locations
- **Component Tests**: `apps/web/tests/components/journeys/`
  - `InstagramStoryInterface.test.tsx`
  - `EnhancedCompanionActivityCard.test.tsx`
  - `OptimalTimingDisplay.test.tsx`
  - `MoodBasedFilter.test.tsx`
- **Integration Tests**: `apps/web/tests/integration/journey-planning.test.ts`
- **E2E Tests**: `apps/web/tests/e2e/journey-experience.spec.ts`

### Key Test Scenarios
- **Journey Progression**: Test horizontal scroll interface and navigation
- **Activity Integration**: Test companion activity display and timing
- **Weather Planning**: Test weather-aware journey alternatives
- **Mood Categorization**: Test journey filtering and recommendations
- **Timing Optimization**: Test optimal timing calculations
- **Mobile Experience**: Test swipe gestures and mobile navigation
- **Offline Functionality**: Test journey caching and offline access
- **Performance**: Test scrolling performance with multiple journey stops

### Testing Standards [Source: architecture/testing-infrastructure.md]
- Mock weather API and timing services for consistent testing
- Test accessibility with keyboard and screen reader simulation
- Include performance testing for horizontal scrolling interface
- Test offline functionality with network simulation
- Verify touch gesture handling on various mobile devices

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| [Current Date] | 1.0 | Initial story creation with comprehensive journey experience design | Scrum Master |

## Dev Agent Record

This section is populated by the development agent during implementation.

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results

Results from QA Agent QA review of the completed story implementation.