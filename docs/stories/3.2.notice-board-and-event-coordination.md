# Story 3.2: Notice Board and Event Coordination

## Status
Draft

## Story
**As a** community participant,  
**I want** a central hub for Indiranagar events and activities with coordination capabilities,  
**so that** I can stay informed about local happenings and coordinate meetups with other explorers.

## Acceptance Criteria

1. Event listing interface with categories (food festivals, markets, cultural events, running groups)
2. Event submission form allowing community members to post and promote local events
3. Visual calendar integration showing upcoming events with filtering by category and date
4. RSVP functionality for events with attendee management and communication features
5. Event discussion threads enabling coordination and information sharing among attendees
6. Integration with Amit's personal event recommendations and community commentary
7. Mobile push notifications for events based on user interests and location preferences

## Tasks / Subtasks

- [ ] Create Event Listing and Display System (AC: 1)
  - [ ] Build event listing interface with category-based organization
  - [ ] Implement event card design with essential information display
  - [ ] Add category filtering (food festivals, markets, cultural events, running groups)
  - [ ] Create event search functionality with date and location filters
  - [ ] Add event detail modal with comprehensive information

- [ ] Build Community Event Submission (AC: 2)
  - [ ] Create event submission form for community members
  - [ ] Add event moderation workflow with admin approval process
  - [ ] Implement recurring event creation and management
  - [ ] Add event photo upload and promotional content management
  - [ ] Create event editing and cancellation capabilities

- [ ] Implement Visual Calendar Integration (AC: 3)
  - [ ] Build interactive calendar component with month/week/day views
  - [ ] Add event overlay display on calendar dates
  - [ ] Implement category-based color coding for events
  - [ ] Create calendar export functionality (iCal/Google Calendar)
  - [ ] Add date range filtering and navigation controls

- [ ] Create RSVP and Attendee Management (AC: 4)
  - [ ] Build RSVP functionality with attendance tracking
  - [ ] Create attendee list display with privacy controls
  - [ ] Add waitlist management for capacity-limited events
  - [ ] Implement attendee communication tools
  - [ ] Create event reminder system for registered attendees

- [ ] Build Event Discussion System (AC: 5)
  - [ ] Create threaded discussion system for each event
  - [ ] Add real-time chat functionality for event coordination
  - [ ] Implement discussion moderation and community guidelines
  - [ ] Add file sharing for event-related documents
  - [ ] Create discussion notification system

- [ ] Integrate Curator Commentary System (AC: 6)
  - [ ] Add Amit's personal event recommendations and insights
  - [ ] Create curator badge system for endorsed events
  - [ ] Implement event rating and review system
  - [ ] Add curator commentary display in event details
  - [ ] Create curator event creation and promotion tools

- [ ] Implement Mobile Push Notifications (AC: 7)
  - [ ] Build notification preference system based on interests
  - [ ] Create location-based event notifications
  - [ ] Add event reminder notifications before events
  - [ ] Implement new event alerts for followed categories
  - [ ] Create notification delivery optimization and batching

## Dev Notes

### Previous Story Insights
- **Story 1.6**: Community question system provides foundation for user engagement
- **Story 3.1**: Community suggestion system provides user management foundation

### Event Data Model
```typescript
interface CommunityEvent {
  id: string;
  title: string;
  description: string;
  category: EventCategory;
  date_time: string;
  end_time?: string;
  location: EventLocation;
  organizer: EventOrganizer;
  capacity?: number;
  cost?: EventCost;
  images: string[];
  status: EventStatus;
  is_recurring: boolean;
  recurrence_pattern?: RecurrencePattern;
  rsvp_count: number;
  attendees: EventAttendee[];
  discussions: EventDiscussion[];
  curator_endorsed: boolean;
  curator_comments?: string;
  created_at: string;
  updated_at: string;
}

type EventCategory = 
  | 'food_festival' 
  | 'market' 
  | 'cultural_event' 
  | 'running_group' 
  | 'meetup' 
  | 'workshop';

interface EventLocation {
  name: string;
  address: string;
  coordinates: Coordinates;
  venue_type: 'indoor' | 'outdoor' | 'hybrid';
}
```

### File Locations
```
apps/web/
├── app/events/
│   ├── page.tsx                     # Event listing page
│   ├── [id]/page.tsx               # Event detail page
│   ├── create/page.tsx             # Event creation
│   └── calendar/page.tsx           # Calendar view
├── components/events/
│   ├── EventCalendar.tsx           # Calendar component
│   ├── EventCard.tsx               # Event display card
│   ├── EventSubmissionForm.tsx     # Community event creation
│   ├── RSVPSystem.tsx              # RSVP management
│   ├── EventDiscussion.tsx         # Discussion threads
│   ├── EventNotifications.tsx      # Push notification system
│   ├── AttendeeManagement.tsx      # Attendee list and communication
│   ├── EventFilters.tsx            # Advanced filtering interface
│   ├── RecurringEventManager.tsx   # Recurring event creation
│   └── EventAnalytics.tsx          # Event performance metrics
```

### Implementation Highlights
- **Calendar Integration**: Full-featured calendar with multiple view modes
- **Real-time Features**: Live chat and notifications for event coordination
- **Community Moderation**: Admin approval workflow for community-submitted events
- **Mobile Optimization**: Push notifications and mobile-friendly event management
- **Curator Integration**: Special highlighting for Amit's recommended events

## Testing

### Key Test Scenarios
- Event creation, editing, and deletion workflow
- RSVP system with capacity management and waitlists
- Calendar display and navigation functionality
- Discussion thread creation and moderation
- Push notification delivery and preferences
- Mobile event browsing and RSVP experience
- Event categorization and filtering
- Recurring event generation and management
- Curator endorsement and community recognition
- Waitlist management and automatic promotion
- Multi-device calendar synchronization
- Real-time attendance updates

### Test File Locations
- **Component Tests**: `apps/web/tests/components/events/`
  - `EventCalendar.test.tsx`
  - `RSVPSystem.test.tsx`
  - `EventCard.test.tsx`
  - `EventSubmissionForm.test.tsx`
  - `EventDiscussion.test.tsx`
- **Integration Tests**: `apps/web/tests/integration/event-coordination.test.ts`
- **E2E Tests**: `apps/web/tests/e2e/event-management.spec.ts`

### Performance Considerations
- **Calendar Optimization**: Virtual scrolling for large event datasets
- **Real-time Updates**: WebSocket connections for live RSVP updates
- **Image Optimization**: Automatic compression for event photos
- **Caching Strategy**: Event data caching with invalidation on updates
- **Mobile Performance**: Optimized touch interactions and gesture support

### Security Measures
- **RSVP Validation**: Email verification for event attendance
- **Spam Prevention**: Rate limiting on event creation and RSVPs
- **Content Moderation**: Admin approval workflow for community events
- **Privacy Controls**: Attendee visibility settings and data protection
- **Event Integrity**: Verification of event details and organizer information

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| [Current Date] | 1.0 | Initial story creation with comprehensive event coordination system | Scrum Master |

## Dev Agent Record

This section is populated by the development agent during implementation.

### Database Schema Implementation

```sql
-- Community Events Schema for Story 3.2
-- Comprehensive event coordination and management system

-- Create events table
CREATE TABLE community_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title VARCHAR(255) NOT NULL,
  description TEXT NOT NULL,
  category VARCHAR(50) NOT NULL CHECK (category IN (
    'food_festival', 'market', 'cultural_event', 'running_group', 'meetup', 'workshop', 'other'
  )),
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ,
  location_name VARCHAR(255) NOT NULL,
  location_address TEXT NOT NULL,
  location_latitude DECIMAL(10, 8) NOT NULL,
  location_longitude DECIMAL(11, 8) NOT NULL,
  venue_type VARCHAR(20) DEFAULT 'indoor' CHECK (venue_type IN ('indoor', 'outdoor', 'hybrid')),
  
  -- Organizer information
  organizer_name VARCHAR(100) NOT NULL,
  organizer_email VARCHAR(255) NOT NULL,
  organizer_phone VARCHAR(20),
  organizer_social JSONB,
  
  -- Event details
  capacity INTEGER,
  cost_type VARCHAR(20) DEFAULT 'free' CHECK (cost_type IN ('free', 'paid', 'donation')),
  cost_amount DECIMAL(10, 2),
  cost_currency VARCHAR(3) DEFAULT 'INR',
  
  -- Status and workflow
  status VARCHAR(30) DEFAULT 'submitted' CHECK (status IN (
    'submitted', 'approved', 'published', 'cancelled', 'completed', 'rejected'
  )),
  
  -- Recurring events
  is_recurring BOOLEAN DEFAULT false,
  recurrence_pattern JSONB, -- {type: 'weekly', interval: 1, days: ['monday'], until: '2024-12-31'}
  parent_event_id UUID REFERENCES community_events(id),
  
  -- Curator features
  curator_endorsed BOOLEAN DEFAULT false,
  curator_comments TEXT,
  curator_rating INTEGER CHECK (curator_rating >= 1 AND curator_rating <= 5),
  
  -- Analytics
  view_count INTEGER DEFAULT 0,
  rsvp_count INTEGER DEFAULT 0,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create event images table
CREATE TABLE event_images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID REFERENCES community_events(id) ON DELETE CASCADE,
  storage_path VARCHAR(500) NOT NULL,
  thumbnail_path VARCHAR(500),
  caption TEXT,
  is_primary BOOLEAN DEFAULT false,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create event RSVPs table
CREATE TABLE event_rsvps (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID REFERENCES community_events(id) ON DELETE CASCADE,
  attendee_name VARCHAR(100) NOT NULL,
  attendee_email VARCHAR(255) NOT NULL,
  attendee_phone VARCHAR(20),
  status VARCHAR(20) DEFAULT 'going' CHECK (status IN ('going', 'maybe', 'not_going', 'waitlist')),
  guest_count INTEGER DEFAULT 0,
  dietary_requirements TEXT,
  accessibility_needs TEXT,
  notes TEXT,
  notification_preferences JSONB DEFAULT '{"email": true, "sms": false}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(event_id, attendee_email)
);

-- Create event discussions table
CREATE TABLE event_discussions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID REFERENCES community_events(id) ON DELETE CASCADE,
  author_name VARCHAR(100) NOT NULL,
  author_email VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  parent_id UUID REFERENCES event_discussions(id), -- For threaded discussions
  is_pinned BOOLEAN DEFAULT false,
  is_organizer_message BOOLEAN DEFAULT false,
  attachments JSONB, -- Array of file paths
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create event categories table for dynamic categorization
CREATE TABLE event_categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(50) UNIQUE NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  description TEXT,
  color_code VARCHAR(7) NOT NULL, -- Hex color for UI
  icon_name VARCHAR(50), -- Icon identifier
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create notification preferences table
CREATE TABLE event_notification_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_email VARCHAR(255) NOT NULL,
  categories JSONB NOT NULL DEFAULT '[]', -- Array of subscribed categories
  location_radius INTEGER DEFAULT 5, -- km radius from Indiranagar
  advance_notice_hours INTEGER DEFAULT 24,
  digest_frequency VARCHAR(20) DEFAULT 'weekly' CHECK (digest_frequency IN ('daily', 'weekly', 'monthly', 'none')),
  push_notifications BOOLEAN DEFAULT true,
  email_notifications BOOLEAN DEFAULT true,
  sms_notifications BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_email)
);

-- Insert default event categories
INSERT INTO event_categories (name, display_name, description, color_code, icon_name, sort_order) VALUES
('food_festival', 'Food Festivals', 'Culinary events and food celebrations', '#E74C3C', 'utensils', 1),
('market', 'Markets', 'Local markets and pop-up shops', '#F39C12', 'shopping-bag', 2),
('cultural_event', 'Cultural Events', 'Art exhibitions, music, and cultural activities', '#9B59B6', 'palette', 3),
('running_group', 'Running Groups', 'Fitness activities and running meetups', '#2ECC71', 'activity', 4),
('meetup', 'Community Meetups', 'Social gatherings and networking events', '#3498DB', 'users', 5),
('workshop', 'Workshops', 'Learning sessions and skill-building events', '#34495E', 'book-open', 6);

-- Create indexes for performance
CREATE INDEX idx_events_category ON community_events(category);
CREATE INDEX idx_events_start_time ON community_events(start_time);
CREATE INDEX idx_events_status ON community_events(status);
CREATE INDEX idx_events_location ON community_events(location_latitude, location_longitude);
CREATE INDEX idx_events_curator_endorsed ON community_events(curator_endorsed) WHERE curator_endorsed = true;
CREATE INDEX idx_event_rsvps_event ON event_rsvps(event_id);
CREATE INDEX idx_event_rsvps_status ON event_rsvps(status);
CREATE INDEX idx_event_discussions_event ON event_discussions(event_id);
CREATE INDEX idx_event_discussions_parent ON event_discussions(parent_id) WHERE parent_id IS NOT NULL;

-- Create triggers for updated_at
CREATE TRIGGER update_events_updated_at
  BEFORE UPDATE ON community_events
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_rsvps_updated_at
  BEFORE UPDATE ON event_rsvps
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Create trigger to update RSVP count
CREATE OR REPLACE FUNCTION update_event_rsvp_count()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' AND NEW.status = 'going' THEN
    UPDATE community_events 
    SET rsvp_count = rsvp_count + 1 + COALESCE(NEW.guest_count, 0)
    WHERE id = NEW.event_id;
  ELSIF TG_OP = 'UPDATE' THEN
    -- Handle status changes
    IF OLD.status != NEW.status THEN
      -- Remove old count
      IF OLD.status = 'going' THEN
        UPDATE community_events 
        SET rsvp_count = rsvp_count - 1 - COALESCE(OLD.guest_count, 0)
        WHERE id = NEW.event_id;
      END IF;
      -- Add new count
      IF NEW.status = 'going' THEN
        UPDATE community_events 
        SET rsvp_count = rsvp_count + 1 + COALESCE(NEW.guest_count, 0)
        WHERE id = NEW.event_id;
      END IF;
    -- Handle guest count changes
    ELSIF OLD.guest_count != NEW.guest_count AND NEW.status = 'going' THEN
      UPDATE community_events 
      SET rsvp_count = rsvp_count + (COALESCE(NEW.guest_count, 0) - COALESCE(OLD.guest_count, 0))
      WHERE id = NEW.event_id;
    END IF;
  ELSIF TG_OP = 'DELETE' AND OLD.status = 'going' THEN
    UPDATE community_events 
    SET rsvp_count = rsvp_count - 1 - COALESCE(OLD.guest_count, 0)
    WHERE id = OLD.event_id;
  END IF;
  
  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER event_rsvp_count_trigger
  AFTER INSERT OR UPDATE OR DELETE ON event_rsvps
  FOR EACH ROW
  EXECUTE FUNCTION update_event_rsvp_count();

-- Row Level Security
ALTER TABLE community_events ENABLE ROW LEVEL SECURITY;
ALTER TABLE event_images ENABLE ROW LEVEL SECURITY;
ALTER TABLE event_rsvps ENABLE ROW LEVEL SECURITY;
ALTER TABLE event_discussions ENABLE ROW LEVEL SECURITY;
ALTER TABLE event_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE event_notification_preferences ENABLE ROW LEVEL SECURITY;

-- Public read access to published events
CREATE POLICY "Public read published events" ON community_events
  FOR SELECT USING (status = 'published');

-- Anonymous can submit events
CREATE POLICY "Anonymous can submit events" ON community_events
  FOR INSERT TO anon WITH CHECK (status = 'submitted');

-- Admin full access
CREATE POLICY "Admin full access to events" ON community_events
  FOR ALL TO authenticated USING (true);

-- Public can RSVP to published events
CREATE POLICY "Public RSVP to published events" ON event_rsvps
  FOR INSERT TO anon WITH CHECK (
    EXISTS(
      SELECT 1 FROM community_events 
      WHERE id = event_rsvps.event_id AND status = 'published'
    )
  );

-- Users can update their own RSVPs
CREATE POLICY "Users can update own RSVPs" ON event_rsvps
  FOR UPDATE TO anon USING (attendee_email = current_setting('request.jwt.claim.email', true));

-- Public can view discussions for published events
CREATE POLICY "Public read event discussions" ON event_discussions
  FOR SELECT USING (
    EXISTS(
      SELECT 1 FROM community_events 
      WHERE id = event_discussions.event_id AND status = 'published'
    )
  );

-- Public can add discussions to published events
CREATE POLICY "Public add event discussions" ON event_discussions
  FOR INSERT TO anon WITH CHECK (
    EXISTS(
      SELECT 1 FROM community_events 
      WHERE id = event_discussions.event_id AND status = 'published'
    )
  );
```

### API Routes Implementation

```typescript
// apps/web/app/api/events/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { z } from 'zod';

const eventSchema = z.object({
  title: z.string().min(5).max(255),
  description: z.string().min(20).max(5000),
  category: z.enum(['food_festival', 'market', 'cultural_event', 'running_group', 'meetup', 'workshop']),
  start_time: z.string().refine(date => !isNaN(Date.parse(date))),
  end_time: z.string().optional().refine(date => !date || !isNaN(Date.parse(date))),
  location_name: z.string().min(2).max(255),
  location_address: z.string().min(10).max(500),
  location_latitude: z.number().min(12.95).max(13.00),
  location_longitude: z.number().min(77.58).max(77.65),
  venue_type: z.enum(['indoor', 'outdoor', 'hybrid']).default('indoor'),
  organizer_name: z.string().min(2).max(100),
  organizer_email: z.string().email(),
  organizer_phone: z.string().optional(),
  capacity: z.number().positive().optional(),
  cost_type: z.enum(['free', 'paid', 'donation']).default('free'),
  cost_amount: z.number().nonnegative().optional(),
  is_recurring: z.boolean().default(false),
  recurrence_pattern: z.object({
    type: z.enum(['daily', 'weekly', 'monthly']),
    interval: z.number().positive(),
    days: z.array(z.string()).optional(),
    until: z.string().optional()
  }).optional()
});

export async function POST(request: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies });
    const body = await request.json();
    
    // Validate input
    const validatedData = eventSchema.parse(body);
    
    // Check rate limiting (max 2 events per day per email)
    const { data: recentEvents } = await supabase
      .from('community_events')
      .select('id')
      .eq('organizer_email', validatedData.organizer_email)
      .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());
    
    if (recentEvents && recentEvents.length >= 2) {
      return NextResponse.json(
        { error: 'Rate limit exceeded. Maximum 2 events per day.' },
        { status: 429 }
      );
    }
    
    // Create event
    const { data: event, error } = await supabase
      .from('community_events')
      .insert([validatedData])
      .select()
      .single();
    
    if (error) throw error;
    
    // Send notification to admin
    await sendNewEventNotification(event);
    
    return NextResponse.json({ 
      success: true, 
      event: {
        id: event.id,
        title: event.title,
        status: event.status
      }
    });
    
  } catch (error) {
    console.error('Event creation error:', error);
    
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Invalid input data', details: error.errors },
        { status: 400 }
      );
    }
    
    return NextResponse.json(
      { error: 'Failed to create event' },
      { status: 500 }
    );
  }
}

export async function GET(request: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies });
    const { searchParams } = new URL(request.url);
    
    const category = searchParams.get('category');
    const startDate = searchParams.get('startDate');
    const endDate = searchParams.get('endDate');
    const status = searchParams.get('status') || 'published';
    const curatorEndorsed = searchParams.get('curatorEndorsed');
    const limit = parseInt(searchParams.get('limit') || '20');
    const offset = parseInt(searchParams.get('offset') || '0');
    
    let query = supabase
      .from('community_events')
      .select(`
        *,
        event_images(*),
        event_categories(display_name, color_code, icon_name),
        rsvp_count
      `)
      .eq('status', status)
      .order('start_time', { ascending: true })
      .range(offset, offset + limit - 1);
    
    if (category && category !== 'all') {
      query = query.eq('category', category);
    }
    
    if (startDate) {
      query = query.gte('start_time', startDate);
    }
    
    if (endDate) {
      query = query.lte('start_time', endDate);
    }
    
    if (curatorEndorsed === 'true') {
      query = query.eq('curator_endorsed', true);
    }
    
    const { data: events, error } = await query;
    
    if (error) throw error;
    
    return NextResponse.json({ events });
    
  } catch (error) {
    console.error('Get events error:', error);
    return NextResponse.json(
      { error: 'Failed to fetch events' },
      { status: 500 }
    );
  }
}
```

```typescript
// apps/web/app/api/events/[id]/rsvp/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { z } from 'zod';

const rsvpSchema = z.object({
  attendee_name: z.string().min(2).max(100),
  attendee_email: z.string().email(),
  attendee_phone: z.string().optional(),
  status: z.enum(['going', 'maybe', 'not_going']).default('going'),
  guest_count: z.number().min(0).max(10).default(0),
  dietary_requirements: z.string().optional(),
  accessibility_needs: z.string().optional(),
  notes: z.string().optional()
});

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const supabase = createRouteHandlerClient({ cookies });
    const eventId = params.id;
    const body = await request.json();
    
    // Validate input
    const validatedData = rsvpSchema.parse(body);
    
    // Check if event exists and is published
    const { data: event, error: eventError } = await supabase
      .from('community_events')
      .select('id, title, capacity, rsvp_count, start_time, organizer_email')
      .eq('id', eventId)
      .eq('status', 'published')
      .single();
    
    if (eventError || !event) {
      return NextResponse.json(
        { error: 'Event not found or not available for RSVP' },
        { status: 404 }
      );
    }
    
    // Check capacity if event has one
    if (event.capacity && validatedData.status === 'going') {
      const totalRequestedSpots = 1 + validatedData.guest_count;
      const availableSpots = event.capacity - event.rsvp_count;
      
      if (totalRequestedSpots > availableSpots) {
        // Add to waitlist if no spots available
        validatedData.status = 'waitlist' as any;
      }
    }
    
    // Create or update RSVP
    const { data: rsvp, error } = await supabase
      .from('event_rsvps')
      .upsert({
        event_id: eventId,
        ...validatedData
      }, {
        onConflict: 'event_id,attendee_email'
      })
      .select()
      .single();
    
    if (error) throw error;
    
    // Send confirmation email
    await sendRSVPConfirmation(event, rsvp);
    
    // Notify organizer
    await notifyOrganizerNewRSVP(event, rsvp);
    
    return NextResponse.json({ 
      success: true, 
      rsvp: {
        status: rsvp.status,
        guest_count: rsvp.guest_count
      },
      message: rsvp.status === 'waitlist' 
        ? 'Added to waitlist - you\'ll be notified if spots become available'
        : 'RSVP confirmed successfully'
    });
    
  } catch (error) {
    console.error('RSVP error:', error);
    
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Invalid RSVP data', details: error.errors },
        { status: 400 }
      );
    }
    
    return NextResponse.json(
      { error: 'Failed to process RSVP' },
      { status: 500 }
    );
  }
}
```

### Enhanced Component Implementations

```typescript
// apps/web/components/events/EventCalendar.tsx
import { useState, useEffect } from 'react';
import { Calendar, ChevronLeft, ChevronRight, Filter } from 'lucide-react';
import { format, startOfMonth, endOfMonth, eachDayOfInterval, isSameMonth, isSameDay } from 'date-fns';
import { CommunityEvent } from '@/lib/types/events';
import { Button } from '@/components/ui/Button';
import { Badge } from '@/components/ui/Badge';
import { EventCard } from './EventCard';

interface EventCalendarProps {
  events: CommunityEvent[];
  onEventSelect?: (event: CommunityEvent) => void;
  selectedCategories?: string[];
  onCategoryFilter?: (categories: string[]) => void;
}

export const EventCalendar = ({ 
  events, 
  onEventSelect, 
  selectedCategories = [], 
  onCategoryFilter 
}: EventCalendarProps) => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  const [viewMode, setViewMode] = useState<'month' | 'week' | 'day'>('month');
  const [showFilters, setShowFilters] = useState(false);

  const monthStart = startOfMonth(currentDate);
  const monthEnd = endOfMonth(currentDate);
  const calendarDays = eachDayOfInterval({ start: monthStart, end: monthEnd });

  const getEventsForDate = (date: Date) => {
    return events.filter(event => 
      isSameDay(new Date(event.start_time), date) &&
      (selectedCategories.length === 0 || selectedCategories.includes(event.category))
    );
  };

  const selectedDateEvents = selectedDate ? getEventsForDate(selectedDate) : [];

  const categoryColors = {
    food_festival: 'bg-red-100 text-red-800',
    market: 'bg-orange-100 text-orange-800',
    cultural_event: 'bg-purple-100 text-purple-800',
    running_group: 'bg-green-100 text-green-800',
    meetup: 'bg-blue-100 text-blue-800',
    workshop: 'bg-gray-100 text-gray-800'
  };

  const navigateMonth = (direction: 'previous' | 'next') => {
    const newDate = new Date(currentDate);
    newDate.setMonth(currentDate.getMonth() + (direction === 'next' ? 1 : -1));
    setCurrentDate(newDate);
  };

  return (
    <div className="event-calendar bg-white rounded-lg shadow-sm border">
      {/* Calendar Header */}
      <div className="p-6 border-b">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center space-x-4">
            <h2 className="text-2xl font-bold text-gray-900">
              {format(currentDate, 'MMMM yyyy')}
            </h2>
            <div className="flex space-x-1">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => navigateMonth('previous')}
              >
                <ChevronLeft className="w-4 h-4" />
              </Button>
              <Button
                variant="ghost"
                size="sm"
                onClick={() => navigateMonth('next')}
              >
                <ChevronRight className="w-4 h-4" />
              </Button>
            </div>
          </div>
          
          <div className="flex items-center space-x-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setShowFilters(!showFilters)}
            >
              <Filter className="w-4 h-4 mr-2" />
              Filters
            </Button>
            
            <div className="flex rounded-lg border overflow-hidden">
              {['month', 'week', 'day'].map((mode) => (
                <button
                  key={mode}
                  className={`px-3 py-1 text-sm capitalize ${
                    viewMode === mode
                      ? 'bg-yellow-400 text-black'
                      : 'bg-white text-gray-600 hover:bg-gray-50'
                  }`}
                  onClick={() => setViewMode(mode as any)}
                >
                  {mode}
                </button>
              ))}
            </div>
          </div>
        </div>
        
        {/* Category Filters */}
        {showFilters && (
          <div className="flex flex-wrap gap-2 pt-4 border-t">
            {Object.entries(categoryColors).map(([category, colorClass]) => {
              const isSelected = selectedCategories.includes(category);
              return (
                <button
                  key={category}
                  className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${
                    isSelected
                      ? 'bg-yellow-400 text-black'
                      : colorClass + ' hover:opacity-80'
                  }`}
                  onClick={() => {
                    const newCategories = isSelected
                      ? selectedCategories.filter(c => c !== category)
                      : [...selectedCategories, category];
                    onCategoryFilter?.(newCategories);
                  }}
                >
                  {category.replace('_', ' ')}
                </button>
              );
            })}
          </div>
        )}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
        {/* Calendar Grid */}
        <div className="lg:col-span-2">
          {viewMode === 'month' && (
            <div className="grid grid-cols-7 gap-1">
              {/* Day headers */}
              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                <div key={day} className="p-2 text-center text-sm font-medium text-gray-500">
                  {day}
                </div>
              ))}
              
              {/* Calendar days */}
              {calendarDays.map(day => {
                const dayEvents = getEventsForDate(day);
                const isSelected = selectedDate && isSameDay(day, selectedDate);
                const isToday = isSameDay(day, new Date());
                
                return (
                  <div
                    key={day.toISOString()}
                    className={`min-h-[80px] p-1 border rounded cursor-pointer transition-colors ${
                      isSelected
                        ? 'bg-yellow-50 border-yellow-400'
                        : isToday
                        ? 'bg-blue-50 border-blue-300'
                        : 'bg-white border-gray-200 hover:bg-gray-50'
                    } ${
                      !isSameMonth(day, currentDate) ? 'opacity-40' : ''
                    }`}
                    onClick={() => setSelectedDate(day)}
                  >
                    <div className={`text-sm font-medium mb-1 ${
                      isToday ? 'text-blue-600' : 'text-gray-900'
                    }`}>
                      {format(day, 'd')}
                    </div>
                    
                    <div className="space-y-1">
                      {dayEvents.slice(0, 2).map(event => (
                        <div
                          key={event.id}
                          className={`text-xs p-1 rounded truncate ${
                            categoryColors[event.category as keyof typeof categoryColors]
                          }`}
                          title={event.title}
                        >
                          {event.title}
                        </div>
                      ))}
                      {dayEvents.length > 2 && (
                        <div className="text-xs text-gray-500 text-center">
                          +{dayEvents.length - 2} more
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* Selected Date Events */}
        <div className="lg:col-span-1">
          <div className="sticky top-6">
            <h3 className="font-semibold text-gray-900 mb-4">
              {selectedDate 
                ? `Events on ${format(selectedDate, 'MMM d, yyyy')}`
                : 'Select a date to view events'
              }
            </h3>
            
            {selectedDateEvents.length === 0 ? (
              <p className="text-gray-500 text-sm">
                {selectedDate ? 'No events on this date.' : 'Click on a calendar date to see events.'}
              </p>
            ) : (
              <div className="space-y-3">
                {selectedDateEvents.map(event => (
                  <EventCard
                    key={event.id}
                    event={event}
                    compact
                    onClick={() => onEventSelect?.(event)}
                  />
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};
```

```typescript
// apps/web/components/events/RSVPSystem.tsx
import { useState, useEffect } from 'react';
import { Users, Clock, MapPin, DollarSign, Calendar } from 'lucide-react';
import { CommunityEvent, EventRSVP } from '@/lib/types/events';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Textarea } from '@/components/ui/Textarea';
import { Badge } from '@/components/ui/Badge';
import { toast } from 'react-toastify';
import { format } from 'date-fns';

interface RSVPSystemProps {
  event: CommunityEvent;
  userRSVP?: EventRSVP;
  onRSVPUpdate?: (rsvp: EventRSVP) => void;
}

export const RSVPSystem = ({ event, userRSVP, onRSVPUpdate }: RSVPSystemProps) => {
  const [showRSVPForm, setShowRSVPForm] = useState(false);
  const [rsvpData, setRSVPData] = useState({
    attendee_name: '',
    attendee_email: '',
    attendee_phone: '',
    status: 'going' as const,
    guest_count: 0,
    dietary_requirements: '',
    accessibility_needs: '',
    notes: ''
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [attendeeList, setAttendeeList] = useState<EventRSVP[]>([]);
  const [showAttendees, setShowAttendees] = useState(false);

  useEffect(() => {
    if (userRSVP) {
      setRSVPData({
        attendee_name: userRSVP.attendee_name,
        attendee_email: userRSVP.attendee_email,
        attendee_phone: userRSVP.attendee_phone || '',
        status: userRSVP.status,
        guest_count: userRSVP.guest_count,
        dietary_requirements: userRSVP.dietary_requirements || '',
        accessibility_needs: userRSVP.accessibility_needs || '',
        notes: userRSVP.notes || ''
      });
    }
  }, [userRSVP]);

  const availableSpots = event.capacity ? event.capacity - event.rsvp_count : null;
  const isFull = availableSpots !== null && availableSpots <= 0;
  const isUpcoming = new Date(event.start_time) > new Date();

  const handleRSVPSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    try {
      const response = await fetch(`/api/events/${event.id}/rsvp`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(rsvpData)
      });

      const result = await response.json();

      if (response.ok) {
        toast.success(result.message || 'RSVP confirmed successfully!');
        onRSVPUpdate?.(result.rsvp);
        setShowRSVPForm(false);
      } else {
        throw new Error(result.error || 'Failed to process RSVP');
      }
    } catch (error) {
      toast.error(error instanceof Error ? error.message : 'Failed to process RSVP');
    } finally {
      setIsSubmitting(false);
    }
  };

  const loadAttendeeList = async () => {
    try {
      const response = await fetch(`/api/events/${event.id}/attendees`);
      if (response.ok) {
        const data = await response.json();
        setAttendeeList(data.attendees);
      }
    } catch (error) {
      console.error('Failed to load attendees:', error);
    }
  };

  const getStatusBadge = (status: string) => {
    const styles = {
      going: 'bg-green-100 text-green-800',
      maybe: 'bg-yellow-100 text-yellow-800',
      not_going: 'bg-red-100 text-red-800',
      waitlist: 'bg-purple-100 text-purple-800'
    };

    return (
      <Badge className={styles[status as keyof typeof styles]}>
        {status === 'not_going' ? 'Not Going' : status.charAt(0).toUpperCase() + status.slice(1)}
      </Badge>
    );
  };

  return (
    <div className="rsvp-system bg-white rounded-lg shadow-sm border p-6">
      {/* Event Summary */}
      <div className="mb-6">
        <h3 className="text-xl font-bold text-gray-900 mb-4">{event.title}</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
          <div className="flex items-center">
            <Calendar className="w-4 h-4 mr-2" />
            <span>{format(new Date(event.start_time), 'MMM d, yyyy at h:mm a')}</span>
          </div>
          
          <div className="flex items-center">
            <MapPin className="w-4 h-4 mr-2" />
            <span>{event.location_name}</span>
          </div>
          
          <div className="flex items-center">
            <Users className="w-4 h-4 mr-2" />
            <span>
              {event.rsvp_count} attending
              {event.capacity && ` (${availableSpots} spots left)`}
            </span>
          </div>
          
          {event.cost_type !== 'free' && (
            <div className="flex items-center">
              <DollarSign className="w-4 h-4 mr-2" />
              <span>
                {event.cost_type === 'paid' 
                  ? `₹${event.cost_amount}` 
                  : 'Donation-based'
                }
              </span>
            </div>
          )}
        </div>
      </div>

      {/* RSVP Status or Form */}
      {!isUpcoming ? (
        <div className="bg-gray-100 rounded-lg p-4 text-center">
          <p className="text-gray-600">This event has already passed.</p>
        </div>
      ) : userRSVP ? (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="font-medium text-gray-900">Your RSVP Status</p>
              <p className="text-sm text-gray-600">
                {userRSVP.guest_count > 0 && `+${userRSVP.guest_count} guests`}
              </p>
            </div>
            {getStatusBadge(userRSVP.status)}
          </div>
          
          <div className="flex space-x-3">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setShowRSVPForm(true)}
            >
              Update RSVP
            </Button>
            
            <Button
              variant="ghost"
              size="sm"
              onClick={() => {
                setShowAttendees(!showAttendees);
                if (!showAttendees) loadAttendeeList();
              }}
            >
              {showAttendees ? 'Hide' : 'View'} Attendees
            </Button>
          </div>
        </div>
      ) : (
        <div className="space-y-4">
          {isFull ? (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <p className="text-yellow-800 font-medium">Event is Full</p>
              <p className="text-yellow-700 text-sm mt-1">
                Join the waitlist to be notified if spots become available.
              </p>
            </div>
          ) : (
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <p className="text-green-800 font-medium">
                {availableSpots ? `${availableSpots} spots available` : 'Spots available'}
              </p>
            </div>
          )}
          
          <Button
            onClick={() => setShowRSVPForm(true)}
            className="w-full"
            size="lg"
          >
            {isFull ? 'Join Waitlist' : 'RSVP for Event'}
          </Button>
        </div>
      )}

      {/* RSVP Form Modal */}
      {showRSVPForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold">
                  {userRSVP ? 'Update RSVP' : 'RSVP for Event'}
                </h3>
                <button
                  onClick={() => setShowRSVPForm(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  ×
                </button>
              </div>
              
              <form onSubmit={handleRSVPSubmit} className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Name *</label>
                    <Input
                      required
                      value={rsvpData.attendee_name}
                      onChange={(e) => setRSVPData(prev => ({
                        ...prev,
                        attendee_name: e.target.value
                      }))}
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Email *</label>
                    <Input
                      type="email"
                      required
                      value={rsvpData.attendee_email}
                      onChange={(e) => setRSVPData(prev => ({
                        ...prev,
                        attendee_email: e.target.value
                      }))}
                    />
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Phone</label>
                  <Input
                    type="tel"
                    value={rsvpData.attendee_phone}
                    onChange={(e) => setRSVPData(prev => ({
                      ...prev,
                      attendee_phone: e.target.value
                    }))}
                  />
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Status</label>
                    <select
                      value={rsvpData.status}
                      onChange={(e) => setRSVPData(prev => ({
                        ...prev,
                        status: e.target.value as any
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="going">Going</option>
                      <option value="maybe">Maybe</option>
                      <option value="not_going">Not Going</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Guests</label>
                    <Input
                      type="number"
                      min="0"
                      max="10"
                      value={rsvpData.guest_count}
                      onChange={(e) => setRSVPData(prev => ({
                        ...prev,
                        guest_count: parseInt(e.target.value) || 0
                      }))}
                    />
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Dietary Requirements</label>
                  <Textarea
                    rows={2}
                    value={rsvpData.dietary_requirements}
                    onChange={(e) => setRSVPData(prev => ({
                      ...prev,
                      dietary_requirements: e.target.value
                    }))}
                    placeholder="Any dietary restrictions or preferences..."
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Accessibility Needs</label>
                  <Textarea
                    rows={2}
                    value={rsvpData.accessibility_needs}
                    onChange={(e) => setRSVPData(prev => ({
                      ...prev,
                      accessibility_needs: e.target.value
                    }))}
                    placeholder="Any accessibility requirements..."
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Notes</label>
                  <Textarea
                    rows={2}
                    value={rsvpData.notes}
                    onChange={(e) => setRSVPData(prev => ({
                      ...prev,
                      notes: e.target.value
                    }))}
                    placeholder="Any additional information..."
                  />
                </div>
                
                <div className="flex space-x-3 pt-4">
                  <Button
                    type="button"
                    variant="ghost"
                    onClick={() => setShowRSVPForm(false)}
                    disabled={isSubmitting}
                  >
                    Cancel
                  </Button>
                  <Button
                    type="submit"
                    disabled={isSubmitting}
                    className="flex-1"
                  >
                    {isSubmitting 
                      ? 'Processing...' 
                      : userRSVP 
                      ? 'Update RSVP' 
                      : 'Confirm RSVP'
                    }
                  </Button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* Attendee List */}
      {showAttendees && (
        <div className="mt-6 pt-6 border-t">
          <h4 className="font-medium text-gray-900 mb-4">Attendees ({attendeeList.length})</h4>
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {attendeeList.map((attendee) => (
              <div key={attendee.id} className="flex items-center justify-between py-2">
                <div>
                  <p className="font-medium text-sm">{attendee.attendee_name}</p>
                  {attendee.guest_count > 0 && (
                    <p className="text-xs text-gray-500">+{attendee.guest_count} guests</p>
                  )}
                </div>
                {getStatusBadge(attendee.status)}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};
```

### Testing Implementation

```typescript
// apps/web/tests/components/events/EventCalendar.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { vi } from 'vitest';
import { EventCalendar } from '@/components/events/EventCalendar';
import { CommunityEvent } from '@/lib/types/events';

const mockEvents: CommunityEvent[] = [
  {
    id: '1',
    title: 'Food Festival',
    category: 'food_festival',
    start_time: '2024-08-15T10:00:00Z',
    status: 'published'
  },
  {
    id: '2',
    title: 'Running Group',
    category: 'running_group',
    start_time: '2024-08-15T06:00:00Z',
    status: 'published'
  }
] as CommunityEvent[];

describe('EventCalendar', () => {
  it('renders calendar with events', () => {
    render(<EventCalendar events={mockEvents} />);
    
    expect(screen.getByText('Food Festival')).toBeInTheDocument();
    expect(screen.getByText('Running Group')).toBeInTheDocument();
  });

  it('filters events by category', () => {
    const onCategoryFilter = vi.fn();
    render(
      <EventCalendar 
        events={mockEvents} 
        onCategoryFilter={onCategoryFilter}
        selectedCategories={['food_festival']}
      />
    );
    
    fireEvent.click(screen.getByRole('button', { name: /filters/i }));
    fireEvent.click(screen.getByText('running group'));
    
    expect(onCategoryFilter).toHaveBeenCalledWith(['food_festival', 'running_group']);
  });

  it('navigates between months', () => {
    render(<EventCalendar events={mockEvents} />);
    
    const nextButton = screen.getByRole('button', { name: /chevronright/i });
    fireEvent.click(nextButton);
    
    // Calendar should show next month
    expect(screen.getByText(/september|october|november|december/i)).toBeInTheDocument();
  });
});
```

## QA Results

Results from QA Agent QA review of the completed story implementation.