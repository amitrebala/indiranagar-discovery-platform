# Story 4.3: Business Relationship Tracking and Leveraging System

## Status
Draft

## Story
**As a** connected local expert,  
**I want** systematic tracking and leveraging of business relationships for enhanced user experiences,  
**so that** I can provide users with insider access and special treatment while building stronger business partnerships.

## Acceptance Criteria

1. Business relationship database tracking connection strength, contact information, and special arrangements
2. "Mention my name" feature integration with specific instructions and benefits for each business relationship
3. Special offer and discount tracking system for community members through business partnerships
4. Business owner contact system for coordinating events, promotions, and community activities
5. Relationship strength indicators showing which businesses provide enhanced experiences for platform users
6. Business partnership analytics tracking referral success and community value generation
7. Business feedback system allowing owners to communicate with platform about customer experiences

## Tasks / Subtasks

- [ ] Create Business Relationship Database (AC: 1)
  - [ ] Design comprehensive business relationship schema
  - [ ] Build relationship strength scoring and tracking system
  - [ ] Create contact information and communication preference management
  - [ ] Add relationship history and interaction timeline
  - [ ] Implement relationship status and tier management

- [ ] Enhance "Mention My Name" System (AC: 2)
  - [ ] Extend existing system from Story 2.2 with detailed instructions
  - [ ] Create business-specific benefit descriptions and guidelines
  - [ ] Add success tracking for "mention my name" referrals
  - [ ] Build user guidance system for leveraging relationships
  - [ ] Create relationship etiquette and usage guidelines

- [ ] Build Special Offers System (AC: 3)
  - [ ] Create offer management system for business partnerships
  - [ ] Add offer redemption tracking and analytics
  - [ ] Build community member verification for exclusive offers
  - [ ] Implement offer expiration and availability management
  - [ ] Create offer promotion and notification system

- [ ] Implement Business Communication System (AC: 4)
  - [ ] Build direct communication interface for business owners
  - [ ] Create event coordination and planning tools
  - [ ] Add promotion collaboration and campaign management
  - [ ] Implement business notification and update system
  - [ ] Build partnership opportunity identification and outreach

- [ ] Create Relationship Strength Indicators (AC: 5)
  - [ ] Design visual relationship strength display system
  - [ ] Build relationship tier badges and indicators
  - [ ] Create enhanced experience descriptions for users
  - [ ] Add relationship strength impact on place recommendations
  - [ ] Implement relationship strength analytics and trends

- [ ] Build Partnership Analytics Dashboard (AC: 6)
  - [ ] Create comprehensive referral tracking and success metrics
  - [ ] Build community value generation analytics
  - [ ] Add ROI tracking for business partnerships
  - [ ] Implement partnership performance reporting
  - [ ] Create business relationship optimization recommendations

- [ ] Implement Business Feedback System (AC: 7)
  - [ ] Build feedback collection system for business owners
  - [ ] Create customer experience reporting and analytics
  - [ ] Add feedback-based relationship strength adjustments
  - [ ] Implement feedback notification and response system
  - [ ] Build feedback integration with place ratings and reviews

## Dev Notes

### Previous Story Insights
- **Story 2.2**: Business relationship indicators provide foundation
- **Story 3.1**: Community engagement patterns for business collaboration

### Business Relationship Data Model
```typescript
interface BusinessRelationship {
  id: string;
  place_id: string;
  contact_person: BusinessContact;
  relationship_type: RelationshipType;
  strength_score: number;
  tier: RelationshipTier;
  special_arrangements: SpecialArrangement[];
  communication_preferences: CommunicationPreference;
  partnership_history: PartnershipEvent[];
  analytics: RelationshipAnalytics;
  created_at: string;
  updated_at: string;
}

interface SpecialArrangement {
  type: 'mention_my_name' | 'special_discount' | 'priority_seating' | 'exclusive_access';
  description: string;
  instructions: string;
  benefits: string;
  usage_count: number;
  success_rate: number;
  active: boolean;
}

interface BusinessContact {
  name: string;
  role: string;
  email: string;
  phone: string;
  preferred_contact_method: ContactMethod;
  availability: ContactAvailability;
}

type RelationshipTier = 'casual' | 'regular' | 'partner' | 'exclusive';
type RelationshipType = 'personal_friend' | 'business_partner' | 'regular_customer' | 'collaboration';
```

### File Locations
```
apps/web/
├── app/admin/business-relationships/
│   ├── page.tsx                     # Relationship management dashboard
│   ├── [id]/page.tsx               # Individual relationship management
│   └── analytics/page.tsx          # Partnership analytics
├── components/business/
│   ├── RelationshipManager.tsx      # Relationship tracking system
│   ├── MentionMyNameSystem.tsx     # Enhanced referral system
│   ├── SpecialOffersManager.tsx    # Offer management
│   ├── BusinessCommunication.tsx   # Business owner communication
│   ├── RelationshipStrengthIndicator.tsx # Visual relationship display
│   └── BusinessFeedback.tsx        # Feedback collection system
├── lib/business/
│   ├── relationships.ts            # Relationship management logic
│   ├── offers.ts                   # Special offers system
│   ├── communication.ts            # Business communication utilities
│   └── analytics.ts                # Partnership analytics
```

### Enhanced "Mention My Name" System
```typescript
const MentionMyNameSystem = ({ place, relationship }: MentionMyNameProps) => {
  const mentionArrangement = relationship.special_arrangements.find(
    arr => arr.type === 'mention_my_name'
  );

  if (!mentionArrangement || !mentionArrangement.active) return null;

  const handleMentionTracking = async () => {
    await trackMentionUsage(relationship.id, mentionArrangement.type);
    await notifyBusinessOfReferral(relationship.contact_person, place);
  };

  return (
    <div className="mention-my-name-system bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
      <div className="flex items-start space-x-3">
        <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
          <Handshake className="w-5 h-5 text-white" />
        </div>
        <div className="flex-1">
          <h3 className="font-semibold text-green-900 mb-2">
            Special Connection: {mentionArrangement.benefits}
          </h3>
          <div className="bg-white rounded-lg p-3 mb-3">
            <h4 className="font-medium text-sm text-green-800 mb-2">How to use:</h4>
            <p className="text-sm text-green-700">{mentionArrangement.instructions}</p>
          </div>
          <div className="flex items-center justify-between">
            <div className="text-xs text-green-600">
              <span className="font-medium">{mentionArrangement.usage_count}</span> community members have used this
            </div>
            <div className="text-xs text-green-600">
              <span className="font-medium">{Math.round(mentionArrangement.success_rate * 100)}%</span> success rate
            </div>
          </div>
          <button
            onClick={handleMentionTracking}
            className="mt-3 px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600"
          >
            I mentioned Amit's name
          </button>
        </div>
      </div>
    </div>
  );
};
```

### Business Communication System
```typescript
const BusinessCommunicationHub = () => {
  const [businesses, setBusinesses] = useState<BusinessRelationship[]>([]);
  const [selectedBusiness, setSelectedBusiness] = useState<BusinessRelationship | null>(null);

  const sendBusinessUpdate = async (businessId: string, message: string, type: CommunicationType) => {
    const business = businesses.find(b => b.id === businessId);
    if (!business) return;

    const communication = {
      business_id: businessId,
      type,
      message,
      sent_at: new Date().toISOString(),
      sent_by: 'platform_admin'
    };

    await sendBusinessCommunication(communication);
    await trackCommunication(businessId, type);
  };

  const coordinateEvent = async (businessId: string, eventDetails: EventCoordination) => {
    const proposal = {
      business_id: businessId,
      event_type: eventDetails.type,
      proposed_date: eventDetails.date,
      details: eventDetails.description,
      community_benefit: eventDetails.community_value,
      business_benefit: eventDetails.business_value
    };

    await createEventProposal(proposal);
    await notifyBusinessOfEventOpportunity(businessId, proposal);
  };

  return (
    <div className="business-communication-hub">
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-1">
          <h2 className="text-xl font-semibold mb-4">Business Partners</h2>
          <div className="space-y-3">
            {businesses.map(business => (
              <BusinessPartnerCard
                key={business.id}
                business={business}
                isSelected={selectedBusiness?.id === business.id}
                onClick={() => setSelectedBusiness(business)}
              />
            ))}
          </div>
        </div>

        <div className="lg:col-span-2">
          {selectedBusiness ? (
            <BusinessCommunicationPanel
              business={selectedBusiness}
              onSendMessage={sendBusinessUpdate}
              onCoordinateEvent={coordinateEvent}
            />
          ) : (
            <div className="text-center text-gray-500 py-12">
              Select a business partner to manage communication
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
```

### Partnership Analytics System
```typescript
const PartnershipAnalytics = {
  calculateRelationshipROI: (relationship: BusinessRelationship) => {
    const referrals = relationship.analytics.referral_count;
    const conversions = relationship.analytics.conversion_count;
    const communityValue = relationship.analytics.community_value_generated;
    const businessValue = relationship.analytics.business_value_generated;

    return {
      referral_conversion_rate: conversions / referrals,
      community_value_per_referral: communityValue / referrals,
      business_value_per_referral: businessValue / referrals,
      total_roi: (businessValue + communityValue) / relationship.analytics.investment_cost,
      relationship_efficiency: relationship.strength_score * (conversions / referrals)
    };
  },

  generatePartnershipReport: async (timeRange: DateRange) => {
    const relationships = await getBusinessRelationships({ active: true });
    const analytics = await Promise.all(
      relationships.map(async (rel) => ({
        relationship: rel,
        roi: PartnershipAnalytics.calculateRelationshipROI(rel),
        trends: await getRelationshipTrends(rel.id, timeRange),
        opportunities: await identifyGrowthOpportunities(rel)
      }))
    );

    return {
      total_partnerships: relationships.length,
      average_strength_score: relationships.reduce((sum, rel) => sum + rel.strength_score, 0) / relationships.length,
      top_performing_partnerships: analytics.sort((a, b) => b.roi.total_roi - a.roi.total_roi).slice(0, 5),
      growth_opportunities: analytics.flatMap(a => a.opportunities),
      community_value_generated: analytics.reduce((sum, a) => sum + a.relationship.analytics.community_value_generated, 0)
    };
  }
};
```

### Special Offers Management
```typescript
const SpecialOffersManager = ({ businessId }: { businessId: string }) => {
  const [offers, setOffers] = useState<SpecialOffer[]>([]);
  const [newOffer, setNewOffer] = useState<Partial<SpecialOffer>>({});

  const createOffer = async (offerData: Partial<SpecialOffer>) => {
    const offer = await createSpecialOffer({
      ...offerData,
      business_id: businessId,
      created_at: new Date().toISOString(),
      status: 'active'
    });

    setOffers(prev => [...prev, offer]);
    await notifyCommunityOfNewOffer(offer);
  };

  const trackOfferRedemption = async (offerId: string, userId: string) => {
    await recordOfferRedemption({
      offer_id: offerId,
      user_id: userId,
      redeemed_at: new Date().toISOString()
    });

    // Update offer analytics
    setOffers(prev => prev.map(offer => 
      offer.id === offerId 
        ? { ...offer, redemption_count: offer.redemption_count + 1 }
        : offer
    ));
  };

  return (
    <div className="special-offers-manager">
      <div className="mb-6">
        <h3 className="text-lg font-semibold mb-4">Community Special Offers</h3>
        <OfferCreationForm onSubmit={createOffer} />
      </div>

      <div className="space-y-4">
        {offers.map(offer => (
          <OfferCard
            key={offer.id}
            offer={offer}
            onRedemptionTracked={(userId) => trackOfferRedemption(offer.id, userId)}
          />
        ))}
      </div>
    </div>
  );
};
```

### Key Features
- **Comprehensive Relationship Tracking**: Full database of business connections and their value
- **Enhanced User Experience**: Special access and benefits through curated relationships
- **Business Value Creation**: Tools for businesses to engage with the community
- **Analytics and Optimization**: Data-driven relationship management and improvement
- **Communication Platform**: Direct channel between platform and business partners
- **Community Benefits**: Exclusive offers and experiences for platform users

## Testing

### Key Test Scenarios
- Business relationship creation, management, and tracking
- "Mention my name" system usage and success tracking
- Special offers creation, distribution, and redemption
- Business communication and event coordination
- Partnership analytics accuracy and ROI calculation
- Feedback system functionality and relationship impact

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| [Current Date] | 1.0 | Initial story creation with comprehensive business relationship system | Scrum Master |

## Dev Agent Record

This section is populated by the development agent during implementation.

## QA Results

Results from QA Agent QA review of the completed story implementation.