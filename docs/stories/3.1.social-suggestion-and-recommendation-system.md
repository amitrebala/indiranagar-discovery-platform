# Story 3.1: Social Suggestion and Recommendation System

## Status
Draft

## Story
**As a** friend or community member,  
**I want** an easy way to suggest new places or share discoveries with Amit,  
**so that** I can contribute to the platform and help expand the neighborhood knowledge base.

## Acceptance Criteria

1. Intuitive suggestion submission form with fields for place name, location, category, and personal notes
2. Photo upload capability for user-submitted place suggestions with automatic compression
3. Suggestion status tracking allowing users to see if their recommendations are under review or published
4. Admin interface for Amit to review, approve, edit, and respond to user suggestions
5. Email notifications for suggestion submitters when their places are featured or published
6. Public attribution system crediting community members for successful suggestions
7. Suggestion voting system allowing other users to upvote recommended places for prioritization

## Tasks / Subtasks

- [ ] Design Community Suggestion Submission Form (AC: 1)
  - [ ] Create intuitive form interface with place name, location, category fields
  - [ ] Add location picker with map integration for accurate coordinates
  - [ ] Implement category selection with predefined options and custom input
  - [ ] Add personal notes section with rich text formatting
  - [ ] Include contact information fields for follow-up communication

- [ ] Build Photo Upload System (AC: 2)
  - [ ] Implement drag-and-drop photo upload interface
  - [ ] Add automatic image compression and optimization
  - [ ] Create image preview functionality with edit/delete options
  - [ ] Support multiple image uploads per suggestion
  - [ ] Add image format validation and size limits

- [ ] Create Suggestion Status Tracking (AC: 3)
  - [ ] Build suggestion status database schema with workflow states
  - [ ] Create user dashboard showing submitted suggestions and their status
  - [ ] Implement status timeline showing progression through review process
  - [ ] Add status change notifications and email updates
  - [ ] Create public suggestion ID system for tracking

- [ ] Build Admin Review Interface (AC: 4)
  - [ ] Create comprehensive admin dashboard for suggestion management
  - [ ] Design suggestion review interface with approve/reject/edit options
  - [ ] Add rich text response editor for communicating with submitters
  - [ ] Implement suggestion editing capabilities before publishing
  - [ ] Create batch operations for managing multiple suggestions

- [ ] Implement Notification System (AC: 5)
  - [ ] Build email notification templates for status changes
  - [ ] Create notification preferences for suggestion submitters
  - [ ] Add personalized thank you messages when suggestions are published
  - [ ] Implement notification delivery tracking and error handling
  - [ ] Create notification history and user preference management

- [ ] Design Public Attribution System (AC: 6)
  - [ ] Create contributor credit display on published place pages
  - [ ] Build community contributors page showcasing successful suggestions
  - [ ] Add optional social media links for contributors
  - [ ] Implement privacy controls for contributor recognition
  - [ ] Create attribution templates for different contribution types

- [ ] Build Community Voting System (AC: 7)
  - [ ] Add upvoting functionality for submitted suggestions
  - [ ] Create voting display and ranking system for prioritization
  - [ ] Implement voting fraud prevention and moderation
  - [ ] Add voting notifications for suggestion submitters
  - [ ] Create community voting leaderboards and engagement metrics

## Dev Notes

### Previous Story Insights
- **Story 1.2**: Place database provides foundation for new place suggestions
- **Story 1.6**: "Has Amit Been Here?" feature provides foundation for community engagement
- **Story 2.2**: Rich place content provides context for suggestion formatting

### Community Suggestion Data Model
```typescript
interface CommunitySuggestion {
  id: string;
  submitter_name: string;
  submitter_email: string;
  submitter_social?: string;
  place_name: string;
  suggested_location: Coordinates;
  category: PlaceCategory;
  personal_notes: string;
  uploaded_images: SuggestionImage[];
  status: SuggestionStatus;
  admin_notes?: string;
  admin_response?: string;
  votes: number;
  voters: string[]; // Anonymous voter tracking
  created_at: string;
  reviewed_at?: string;
  published_at?: string;
  published_place_id?: string;
}

interface SuggestionImage {
  id: string;
  original_url: string;
  compressed_url: string;
  thumbnail_url: string;
  caption?: string;
  order: number;
}

type SuggestionStatus = 
  | 'submitted' 
  | 'under_review' 
  | 'approved' 
  | 'published' 
  | 'rejected' 
  | 'needs_clarification';
```

### File Locations for Community Features
```
apps/web/
â”œâ”€â”€ app/suggest/
â”‚   â””â”€â”€ page.tsx                     # Community suggestion submission page
â”œâ”€â”€ app/admin/suggestions/
â”‚   â””â”€â”€ page.tsx                     # Admin suggestion management
â”œâ”€â”€ app/contributors/
â”‚   â””â”€â”€ page.tsx                     # Community contributors showcase
â”œâ”€â”€ components/community/
â”‚   â”œâ”€â”€ SuggestionForm.tsx          # Enhanced from Story 1.6
â”‚   â”œâ”€â”€ SuggestionStatusTracker.tsx  # Status tracking interface
â”‚   â”œâ”€â”€ AdminSuggestionReview.tsx   # Admin review interface
â”‚   â”œâ”€â”€ CommunityVoting.tsx         # Voting system component
â”‚   â”œâ”€â”€ ContributorAttribution.tsx  # Attribution display
â”‚   â”œâ”€â”€ SuggestionPhotoUpload.tsx   # Photo upload component
â”‚   â”œâ”€â”€ SuggestionCard.tsx          # Individual suggestion display
â”‚   â”œâ”€â”€ SuggestionDetailPanel.tsx   # Detailed suggestion review
â”‚   â””â”€â”€ BulkSuggestionActions.tsx   # Batch operations interface
â”œâ”€â”€ lib/community/
â”‚   â”œâ”€â”€ suggestions.ts              # Suggestion management utilities
â”‚   â”œâ”€â”€ voting.ts                   # Community voting logic
â”‚   â”œâ”€â”€ notifications.ts            # Notification system
â”‚   â””â”€â”€ image-processing.ts         # Image compression and optimization
```

### Suggestion Submission Form Implementation
```typescript
const CommunitySuggestionForm = () => {
  const [formData, setFormData] = useState<SuggestionFormData>({
    submitter_name: '',
    submitter_email: '',
    place_name: '',
    suggested_location: null,
    category: '',
    personal_notes: '',
    images: []
  });
  
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitStatus, setSubmitStatus] = useState<'idle' | 'success' | 'error'>('idle');

  const handleLocationSelect = (coordinates: Coordinates) => {
    setFormData(prev => ({
      ...prev,
      suggested_location: coordinates
    }));
  };

  const handleImageUpload = async (files: FileList) => {
    const uploadedImages: SuggestionImage[] = [];
    
    for (const file of Array.from(files)) {
      // Compress image before upload
      const compressedFile = await compressImage(file, {
        maxWidth: 1200,
        maxHeight: 800,
        quality: 0.8
      });
      
      // Generate thumbnail
      const thumbnail = await generateThumbnail(file, {
        width: 300,
        height: 200
      });
      
      const imageData: SuggestionImage = {
        id: generateId(),
        original_url: URL.createObjectURL(file),
        compressed_url: URL.createObjectURL(compressedFile),
        thumbnail_url: URL.createObjectURL(thumbnail),
        order: uploadedImages.length
      };
      
      uploadedImages.push(imageData);
    }
    
    setFormData(prev => ({
      ...prev,
      images: [...prev.images, ...uploadedImages]
    }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    
    try {
      const suggestion = await submitCommunitySuggestion(formData);
      setSubmitStatus('success');
      
      // Show thank you message with tracking ID
      toast.success(`Thank you! Your suggestion has been submitted. Track it with ID: ${suggestion.id}`);
      
      // Reset form
      setFormData(initialFormData);
    } catch (error) {
      setSubmitStatus('error');
      toast.error('Failed to submit suggestion. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="community-suggestion-form space-y-6">
      <div className="form-section">
        <h2 className="text-xl font-semibold mb-4">Suggest a New Place</h2>
        <p className="text-gray-600 mb-6">
          Help expand Indiranagar's discovery platform by sharing your favorite places!
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label className="block text-sm font-medium mb-2">Your Name</label>
          <input
            type="text"
            required
            value={formData.submitter_name}
            onChange={(e) => setFormData(prev => ({ ...prev, submitter_name: e.target.value }))}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400"
          />
        </div>
        
        <div>
          <label className="block text-sm font-medium mb-2">Email (for updates)</label>
          <input
            type="email"
            required
            value={formData.submitter_email}
            onChange={(e) => setFormData(prev => ({ ...prev, submitter_email: e.target.value }))}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400"
          />
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium mb-2">Place Name</label>
        <input
          type="text"
          required
          value={formData.place_name}
          onChange={(e) => setFormData(prev => ({ ...prev, place_name: e.target.value }))}
          placeholder="e.g., Amazing Coffee House"
          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400"
        />
      </div>

      <div>
        <label className="block text-sm font-medium mb-2">Location</label>
        <LocationPicker
          onLocationSelect={handleLocationSelect}
          selectedLocation={formData.suggested_location}
          center={{ lat: 12.9716, lng: 77.5946 }} // Indiranagar center
        />
      </div>

      <div>
        <label className="block text-sm font-medium mb-2">Category</label>
        <select
          required
          value={formData.category}
          onChange={(e) => setFormData(prev => ({ ...prev, category: e.target.value }))}
          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400"
        >
          <option value="">Select a category</option>
          <option value="restaurant">Restaurant</option>
          <option value="cafe">Cafe</option>
          <option value="bar">Bar</option>
          <option value="shopping">Shopping</option>
          <option value="culture">Culture</option>
          <option value="activity">Activity</option>
        </select>
      </div>

      <div>
        <label className="block text-sm font-medium mb-2">Photos</label>
        <SuggestionPhotoUpload
          images={formData.images}
          onImagesChange={handleImageUpload}
          maxImages={5}
        />
      </div>

      <div>
        <label className="block text-sm font-medium mb-2">Tell us about this place</label>
        <textarea
          value={formData.personal_notes}
          onChange={(e) => setFormData(prev => ({ ...prev, personal_notes: e.target.value }))}
          placeholder="What makes this place special? When did you discover it? What should people know?"
          rows={4}
          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400"
        />
      </div>

      <button
        type="submit"
        disabled={isSubmitting}
        className="w-full bg-yellow-400 text-black font-medium py-3 rounded-lg hover:bg-yellow-500 disabled:opacity-50"
      >
        {isSubmitting ? 'Submitting...' : 'Submit Suggestion'}
      </button>
    </form>
  );
};
```

### Admin Review Interface
```typescript
const AdminSuggestionReview = () => {
  const [suggestions, setSuggestions] = useState<CommunitySuggestion[]>([]);
  const [filter, setFilter] = useState<SuggestionStatus | 'all'>('all');
  const [selectedSuggestion, setSelectedSuggestion] = useState<CommunityS uggestion | null>(null);

  useEffect(() => {
    loadSuggestions();
  }, [filter]);

  const loadSuggestions = async () => {
    const data = await getSuggestions({ status: filter === 'all' ? undefined : filter });
    setSuggestions(data);
  };

  const handleStatusChange = async (suggestionId: string, newStatus: SuggestionStatus, adminNotes?: string) => {
    await updateSuggestionStatus(suggestionId, newStatus, adminNotes);
    
    // Send notification to submitter
    const suggestion = suggestions.find(s => s.id === suggestionId);
    if (suggestion) {
      await sendStatusUpdateNotification(suggestion, newStatus);
    }
    
    loadSuggestions();
  };

  const convertToPlace = async (suggestion: CommunitySuggestion) => {
    const newPlace = await createPlaceFromSuggestion(suggestion);
    await handleStatusChange(suggestion.id, 'published');
    
    // Show success message
    toast.success(`Place "${newPlace.name}" has been published and attributed to ${suggestion.submitter_name}`);
  };

  return (
    <div className="admin-suggestion-review">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">Community Suggestions</h1>
        
        <select
          value={filter}
          onChange={(e) => setFilter(e.target.value as SuggestionStatus | 'all')}
          className="px-3 py-2 border border-gray-300 rounded-lg"
        >
          <option value="all">All Suggestions</option>
          <option value="submitted">New Submissions</option>
          <option value="under_review">Under Review</option>
          <option value="approved">Approved</option>
          <option value="published">Published</option>
          <option value="needs_clarification">Needs Clarification</option>
        </select>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-1">
          <div className="space-y-4">
            {suggestions.map((suggestion) => (
              <SuggestionCard
                key={suggestion.id}
                suggestion={suggestion}
                isSelected={selectedSuggestion?.id === suggestion.id}
                onClick={() => setSelectedSuggestion(suggestion)}
              />
            ))}
          </div>
        </div>

        <div className="lg:col-span-2">
          {selectedSuggestion ? (
            <SuggestionDetailPanel
              suggestion={selectedSuggestion}
              onStatusChange={handleStatusChange}
              onConvertToPlace={convertToPlace}
            />
          ) : (
            <div className="text-center text-gray-500 py-12">
              Select a suggestion to review
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
```

### Community Voting System
```typescript
const CommunityVoting = ({ suggestion }: { suggestion: CommunitySuggestion }) => {
  const [hasVoted, setHasVoted] = useState(false);
  const [voteCount, setVoteCount] = useState(suggestion.votes);
  const [isVoting, setIsVoting] = useState(false);

  useEffect(() => {
    checkVotingStatus();
  }, [suggestion.id]);

  const checkVotingStatus = async () => {
    const votingStatus = await hasUserVoted(suggestion.id);
    setHasVoted(votingStatus);
  };

  const handleVote = async () => {
    if (hasVoted || isVoting) return;
    
    setIsVoting(true);
    try {
      await voteSuggestion(suggestion.id);
      setHasVoted(true);
      setVoteCount(prev => prev + 1);
      
      // Send notification to suggestion submitter
      await notifySubmitterOfVote(suggestion);
      
      toast.success('Thank you for voting! This helps prioritize community suggestions.');
    } catch (error) {
      toast.error('Failed to vote. Please try again.');
    } finally {
      setIsVoting(false);
    }
  };

  return (
    <div className="community-voting flex items-center space-x-3">
      <button
        onClick={handleVote}
        disabled={hasVoted || isVoting}
        className={`flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors ${
          hasVoted 
            ? 'bg-green-100 text-green-800' 
            : 'bg-gray-100 hover:bg-yellow-100 text-gray-700'
        }`}
      >
        <ThumbsUp className={`w-4 h-4 ${hasVoted ? 'fill-current' : ''}`} />
        <span>{voteCount}</span>
      </button>
      
      <span className="text-sm text-gray-600">
        {hasVoted ? 'You voted for this!' : 'Vote to prioritize'}
      </span>
    </div>
  );
};
```

### Public Attribution System
```typescript
const ContributorAttribution = ({ place }: { place: Place }) => {
  const [contributor, setContributor] = useState<Contributor | null>(null);

  useEffect(() => {
    if (place.contributed_by) {
      loadContributorInfo(place.contributed_by);
    }
  }, [place.contributed_by]);

  const loadContributorInfo = async (contributorId: string) => {
    const contributorData = await getContributor(contributorId);
    setContributor(contributorData);
  };

  if (!contributor) return null;

  return (
    <div className="contributor-attribution bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
      <div className="flex items-center space-x-3">
        <div className="w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center">
          <User className="w-5 h-5 text-black" />
        </div>
        <div>
          <p className="text-sm text-gray-700">
            <span className="font-medium">Community Discovery</span> by{' '}
            <span className="font-semibold text-yellow-800">{contributor.name}</span>
          </p>
          <p className="text-xs text-gray-600">
            Suggested {formatDistanceToNow(new Date(place.contributed_at))} ago
          </p>
        </div>
      </div>
      
      {contributor.social_links && (
        <div className="mt-3 flex space-x-2">
          {contributor.social_links.map((link) => (
            <a
              key={link.platform}
              href={link.url}
              target="_blank"
              rel="noopener noreferrer"
              className="text-xs bg-white px-2 py-1 rounded-full border border-yellow-300 hover:bg-yellow-100"
            >
              {link.platform}
            </a>
          ))}
        </div>
      )}
    </div>
  );
};
```

### Notification System Integration [Source: Story 1.6]
```typescript
const SuggestionNotifications = {
  sendStatusUpdate: async (suggestion: CommunityS uggestion, newStatus: SuggestionStatus) => {
    const templates = {
      under_review: {
        subject: `Your suggestion "${suggestion.place_name}" is under review`,
        body: `Hi ${suggestion.submitter_name},\n\nThank you for suggesting ${suggestion.place_name}! Amit is currently reviewing your suggestion and will get back to you soon.\n\nTrack your suggestion: ${getTrackingUrl(suggestion.id)}`
      },
      approved: {
        subject: `Great news! "${suggestion.place_name}" has been approved`,
        body: `Hi ${suggestion.submitter_name},\n\nExciting news! Your suggestion for ${suggestion.place_name} has been approved and will be featured on the platform soon.\n\nYou'll be credited as the community contributor who discovered this gem!`
      },
      published: {
        subject: `ðŸŽ‰ Your suggestion "${suggestion.place_name}" is now live!`,
        body: `Hi ${suggestion.submitter_name},\n\n${suggestion.place_name} is now live on the Indiranagar Discovery Platform!\n\nView your contribution: ${getPlaceUrl(suggestion.published_place_id)}\n\nThank you for helping expand our neighborhood knowledge base!`
      }
    };

    const template = templates[newStatus];
    if (template) {
      await sendEmail({
        to: suggestion.submitter_email,
        subject: template.subject,
        body: template.body
      });
    }
  }
};
```

### Performance and Moderation
- **Image Optimization**: Automatic compression and thumbnail generation
- **Spam Prevention**: Rate limiting and content moderation
- **Quality Control**: Admin review workflow with approval gates
- **Community Moderation**: Voting system helps prioritize quality suggestions
- **Attribution Tracking**: Complete audit trail for community contributions

### Integration Dependencies
- **Story 1.2**: Place database for converting suggestions to places
- **Story 1.6**: Community question system provides foundation
- **Story 2.2**: Rich place content for suggestion formatting

### Privacy and Data Management
- **Contributor Privacy**: Optional public attribution with privacy controls
- **Email Preferences**: Notification preferences and unsubscribe options
- **Data Retention**: Clear policies for suggestion data and contributor information
- **GDPR Compliance**: Right to delete and data export capabilities

### Accessibility Features [Source: architecture/coding-standards.md]
- **Form Accessibility**: Proper labels, ARIA descriptions, error messaging
- **Keyboard Navigation**: Full keyboard navigation through all interfaces
- **Screen Reader Support**: Proper semantic markup and ARIA labels
- **Visual Accessibility**: High contrast support and scalable text
- **Mobile Accessibility**: Touch-friendly interfaces with adequate target sizes

## Testing

### Testing Framework [Source: architecture/testing-infrastructure.md]
- **Component Tests**: Suggestion forms, voting systems, and admin interfaces
- **Integration Tests**: End-to-end suggestion workflow from submission to publication
- **E2E Tests**: Complete community contribution and recognition flow
- **Performance Tests**: Image upload and processing performance

### Test File Locations
- **Component Tests**: `apps/web/tests/components/community/`
  - `CommunitySuggestionForm.test.tsx`
  - `AdminSuggestionReview.test.tsx`
  - `CommunityVoting.test.tsx`
  - `ContributorAttribution.test.tsx`
  - `SuggestionCard.test.tsx`
  - `BulkSuggestionActions.test.tsx`
  - `MobileSuggestionForm.test.tsx`
- **Integration Tests**: `apps/web/tests/integration/community-suggestions.test.ts`
- **E2E Tests**: `apps/web/tests/e2e/community-contribution.spec.ts`

### Key Test Scenarios
- **Suggestion Submission**: Test form validation, image upload, and submission process
- **Admin Review Workflow**: Test suggestion review, approval, and publication
- **Voting System**: Test community voting and fraud prevention
- **Attribution System**: Test contributor recognition and credit display
- **Notification System**: Test email notifications for status changes
- **Mobile Experience**: Test suggestion submission on mobile devices
- **Performance**: Test image compression and upload performance
- **Accessibility**: Test keyboard navigation and screen reader compatibility

### Testing Standards [Source: architecture/testing-infrastructure.md]
- Mock email services for notification testing
- Test image processing and compression functionality
- Include accessibility testing with automated tools
- Test spam prevention and moderation features
- Verify attribution and recognition systems work correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| [Current Date] | 1.0 | Initial story creation with comprehensive social suggestion and recommendation system | Scrum Master |

## Dev Agent Record

This section is populated by the development agent during implementation.

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

### Database Schema Extensions

```sql
-- Enhanced community suggestions schema for Story 3.1
-- Extends existing suggestions table with voting and attribution

-- Create community_place_suggestions table (separate from questions)
CREATE TABLE community_place_suggestions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  submitter_name VARCHAR(100) NOT NULL,
  submitter_email VARCHAR(255) NOT NULL CHECK (submitter_email ~* '^[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}$'),
  submitter_social JSONB, -- Social media handles
  place_name VARCHAR(255) NOT NULL,
  suggested_latitude DECIMAL(10, 8) NOT NULL,
  suggested_longitude DECIMAL(11, 8) NOT NULL,
  category VARCHAR(100) NOT NULL,
  personal_notes TEXT NOT NULL,
  status VARCHAR(30) DEFAULT 'submitted' CHECK (status IN (
    'submitted', 'under_review', 'approved', 'published', 'rejected', 'needs_clarification'
  )),
  admin_notes TEXT,
  admin_response TEXT,
  votes INTEGER DEFAULT 0,
  published_place_id UUID REFERENCES places(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  reviewed_at TIMESTAMPTZ,
  published_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create suggestion images table
CREATE TABLE suggestion_images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  suggestion_id UUID REFERENCES community_place_suggestions(id) ON DELETE CASCADE,
  storage_path VARCHAR(500) NOT NULL,
  compressed_path VARCHAR(500),
  thumbnail_path VARCHAR(500),
  caption TEXT,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create suggestion votes table for tracking individual votes
CREATE TABLE suggestion_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  suggestion_id UUID REFERENCES community_place_suggestions(id) ON DELETE CASCADE,
  voter_fingerprint VARCHAR(64) NOT NULL, -- Browser fingerprint for anonymous voting
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(suggestion_id, voter_fingerprint)
);

-- Create contributors table for attribution
CREATE TABLE contributors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  social_links JSONB,
  privacy_settings JSONB DEFAULT '{"public_attribution": true}',
  total_suggestions INTEGER DEFAULT 0,
  published_suggestions INTEGER DEFAULT 0,
  first_contribution TIMESTAMPTZ DEFAULT NOW(),
  last_activity TIMESTAMPTZ DEFAULT NOW(),
  recognition_level VARCHAR(20) DEFAULT 'newcomer' CHECK (recognition_level IN (
    'newcomer', 'contributor', 'local_insider', 'community_champion'
  )),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes for performance
CREATE INDEX idx_community_suggestions_status ON community_place_suggestions(status);
CREATE INDEX idx_community_suggestions_created ON community_place_suggestions(created_at DESC);
CREATE INDEX idx_community_suggestions_votes ON community_place_suggestions(votes DESC);
CREATE INDEX idx_community_suggestions_submitter ON community_place_suggestions(submitter_email);
CREATE INDEX idx_suggestion_images_suggestion ON suggestion_images(suggestion_id);
CREATE INDEX idx_suggestion_votes_suggestion ON suggestion_votes(suggestion_id);
CREATE INDEX idx_contributors_email ON contributors(email);
CREATE INDEX idx_contributors_recognition ON contributors(recognition_level);

-- Create triggers for updated_at
CREATE TRIGGER update_community_suggestions_updated_at
  BEFORE UPDATE ON community_place_suggestions
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_contributors_updated_at
  BEFORE UPDATE ON contributors
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Create trigger to update vote count
CREATE OR REPLACE FUNCTION update_suggestion_vote_count()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE community_place_suggestions 
    SET votes = votes + 1 
    WHERE id = NEW.suggestion_id;
    RETURN NEW;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE community_place_suggestions 
    SET votes = votes - 1 
    WHERE id = OLD.suggestion_id;
    RETURN OLD;
  END IF;
  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER suggestion_vote_count_trigger
  AFTER INSERT OR DELETE ON suggestion_votes
  FOR EACH ROW
  EXECUTE FUNCTION update_suggestion_vote_count();

-- Create trigger to update contributor stats
CREATE OR REPLACE FUNCTION update_contributor_stats()
RETURNS TRIGGER AS $$
BEGIN
  -- Update contributor stats when suggestion status changes
  IF NEW.status = 'published' AND OLD.status != 'published' THEN
    UPDATE contributors 
    SET 
      published_suggestions = published_suggestions + 1,
      last_activity = NOW()
    WHERE email = NEW.submitter_email;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER contributor_stats_trigger
  AFTER UPDATE OF status ON community_place_suggestions
  FOR EACH ROW
  EXECUTE FUNCTION update_contributor_stats();

-- Row Level Security policies
ALTER TABLE community_place_suggestions ENABLE ROW LEVEL SECURITY;
ALTER TABLE suggestion_images ENABLE ROW LEVEL SECURITY;
ALTER TABLE suggestion_votes ENABLE ROW LEVEL SECURITY;
ALTER TABLE contributors ENABLE ROW LEVEL SECURITY;

-- Allow public read access to published suggestions
CREATE POLICY "Public read published suggestions" ON community_place_suggestions
  FOR SELECT USING (status = 'published');

-- Allow anonymous submission of suggestions
CREATE POLICY "Anonymous can submit suggestions" ON community_place_suggestions
  FOR INSERT TO anon WITH CHECK (true);

-- Allow admin full access
CREATE POLICY "Admin full access to suggestions" ON community_place_suggestions
  FOR ALL TO authenticated USING (true);

-- Allow public voting
CREATE POLICY "Public can vote on suggestions" ON suggestion_votes
  FOR INSERT TO anon WITH CHECK (true);

-- Allow public read access to contributor info (respecting privacy)
CREATE POLICY "Public read contributors" ON contributors
  FOR SELECT USING ((privacy_settings->>'public_attribution')::boolean = true);
```

### API Routes Implementation

```typescript
// apps/web/app/api/suggestions/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { z } from 'zod';

const suggestionSchema = z.object({
  submitter_name: z.string().min(2).max(100),
  submitter_email: z.string().email(),
  submitter_social: z.object({
    instagram: z.string().optional(),
    twitter: z.string().optional(),
    linkedin: z.string().optional()
  }).optional(),
  place_name: z.string().min(2).max(255),
  suggested_latitude: z.number().min(12.95).max(13.00),
  suggested_longitude: z.number().min(77.58).max(77.65),
  category: z.enum(['restaurant', 'cafe', 'bar', 'shopping', 'culture', 'activity']),
  personal_notes: z.string().min(10).max(2000)
});

export async function POST(request: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies });
    const body = await request.json();
    
    // Validate input
    const validatedData = suggestionSchema.parse(body);
    
    // Check rate limiting (max 3 suggestions per day per email)
    const { data: recentSuggestions } = await supabase
      .from('community_place_suggestions')
      .select('id')
      .eq('submitter_email', validatedData.submitter_email)
      .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());
    
    if (recentSuggestions && recentSuggestions.length >= 3) {
      return NextResponse.json(
        { error: 'Rate limit exceeded. Maximum 3 suggestions per day.' },
        { status: 429 }
      );
    }
    
    // Create suggestion
    const { data: suggestion, error } = await supabase
      .from('community_place_suggestions')
      .insert([validatedData])
      .select()
      .single();
    
    if (error) throw error;
    
    // Create or update contributor record
    await supabase
      .from('contributors')
      .upsert({
        name: validatedData.submitter_name,
        email: validatedData.submitter_email,
        social_links: validatedData.submitter_social,
        total_suggestions: 1,
        last_activity: new Date().toISOString()
      }, {
        onConflict: 'email',
        ignoreDuplicates: false
      });
    
    // Send notification email to admin
    await sendNewSuggestionNotification(suggestion);
    
    return NextResponse.json({ 
      success: true, 
      suggestion: {
        id: suggestion.id,
        place_name: suggestion.place_name,
        status: suggestion.status
      }
    });
    
  } catch (error) {
    console.error('Suggestion submission error:', error);
    
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Invalid input data', details: error.errors },
        { status: 400 }
      );
    }
    
    return NextResponse.json(
      { error: 'Failed to submit suggestion' },
      { status: 500 }
    );
  }
}

export async function GET(request: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies });
    const { searchParams } = new URL(request.url);
    const status = searchParams.get('status');
    const limit = parseInt(searchParams.get('limit') || '20');
    const offset = parseInt(searchParams.get('offset') || '0');
    
    let query = supabase
      .from('community_place_suggestions')
      .select(`
        *,
        suggestion_images(*),
        contributors(name, recognition_level)
      `)
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1);
    
    if (status && status !== 'all') {
      query = query.eq('status', status);
    }
    
    const { data: suggestions, error } = await query;
    
    if (error) throw error;
    
    return NextResponse.json({ suggestions });
    
  } catch (error) {
    console.error('Get suggestions error:', error);
    return NextResponse.json(
      { error: 'Failed to fetch suggestions' },
      { status: 500 }
    );
  }
}
```

```typescript
// apps/web/app/api/suggestions/[id]/vote/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import crypto from 'crypto';

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const supabase = createRouteHandlerClient({ cookies });
    const suggestionId = params.id;
    
    // Create voter fingerprint from IP + User-Agent
    const ip = request.ip || request.headers.get('x-forwarded-for') || 'unknown';
    const userAgent = request.headers.get('user-agent') || 'unknown';
    const fingerprint = crypto
      .createHash('sha256')
      .update(ip + userAgent)
      .digest('hex');
    
    // Check if already voted
    const { data: existingVote } = await supabase
      .from('suggestion_votes')
      .select('id')
      .eq('suggestion_id', suggestionId)
      .eq('voter_fingerprint', fingerprint)
      .single();
    
    if (existingVote) {
      return NextResponse.json(
        { error: 'Already voted for this suggestion' },
        { status: 409 }
      );
    }
    
    // Add vote
    const { error } = await supabase
      .from('suggestion_votes')
      .insert({
        suggestion_id: suggestionId,
        voter_fingerprint: fingerprint,
        ip_address: ip,
        user_agent: userAgent
      });
    
    if (error) throw error;
    
    // Get updated vote count
    const { data: suggestion } = await supabase
      .from('community_place_suggestions')
      .select('votes, submitter_email, place_name')
      .eq('id', suggestionId)
      .single();
    
    // Send notification to submitter
    await sendVoteNotification(suggestion);
    
    return NextResponse.json({ 
      success: true, 
      votes: suggestion?.votes || 0 
    });
    
  } catch (error) {
    console.error('Voting error:', error);
    return NextResponse.json(
      { error: 'Failed to record vote' },
      { status: 500 }
    );
  }
}
```

### Enhanced Component Implementations

```typescript
// apps/web/components/community/SuggestionCard.tsx
import { CommunitySuggestion } from '@/lib/types/community';
import { MapPin, ThumbsUp, Clock, User } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { Badge } from '@/components/ui/Badge';
import { CommunityVoting } from './CommunityVoting';

interface SuggestionCardProps {
  suggestion: CommunitySuggestion;
  isSelected?: boolean;
  onClick?: () => void;
  showVoting?: boolean;
}

export const SuggestionCard = ({ 
  suggestion, 
  isSelected, 
  onClick, 
  showVoting = false 
}: SuggestionCardProps) => {
  const statusColors = {
    submitted: 'bg-blue-100 text-blue-800',
    under_review: 'bg-yellow-100 text-yellow-800',
    approved: 'bg-green-100 text-green-800',
    published: 'bg-emerald-100 text-emerald-800',
    rejected: 'bg-red-100 text-red-800',
    needs_clarification: 'bg-orange-100 text-orange-800'
  };

  return (
    <div 
      className={`p-4 border rounded-lg cursor-pointer transition-all hover:shadow-md ${
        isSelected ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200 bg-white'
      }`}
      onClick={onClick}
    >
      <div className="flex items-start justify-between mb-3">
        <div className="flex-1">
          <h3 className="font-semibold text-lg text-gray-900 mb-1">
            {suggestion.place_name}
          </h3>
          <div className="flex items-center text-sm text-gray-600 mb-2">
            <MapPin className="w-4 h-4 mr-1" />
            <span>Suggested location in Indiranagar</span>
          </div>
        </div>
        
        <Badge className={statusColors[suggestion.status]}>
          {suggestion.status.replace('_', ' ')}
        </Badge>
      </div>

      <p className="text-gray-700 text-sm mb-3 line-clamp-2">
        {suggestion.personal_notes}
      </p>

      <div className="flex items-center justify-between">
        <div className="flex items-center text-xs text-gray-500">
          <User className="w-3 h-3 mr-1" />
          <span>{suggestion.submitter_name}</span>
          <Clock className="w-3 h-3 ml-3 mr-1" />
          <span>{formatDistanceToNow(new Date(suggestion.created_at))} ago</span>
        </div>
        
        {showVoting && suggestion.status === 'submitted' && (
          <CommunityVoting suggestion={suggestion} />
        )}
      </div>

      {suggestion.suggestion_images && suggestion.suggestion_images.length > 0 && (
        <div className="mt-3 flex space-x-2">
          {suggestion.suggestion_images.slice(0, 3).map((image, index) => (
            <img
              key={image.id}
              src={image.thumbnail_path}
              alt={image.caption || 'Suggestion photo'}
              className="w-12 h-12 rounded object-cover"
            />
          ))}
          {suggestion.suggestion_images.length > 3 && (
            <div className="w-12 h-12 rounded bg-gray-100 flex items-center justify-center text-xs text-gray-600">
              +{suggestion.suggestion_images.length - 3}
            </div>
          )}
        </div>
      )}
    </div>
  );
};
```

```typescript
// apps/web/components/community/BulkSuggestionActions.tsx
import { useState } from 'react';
import { CommunitySuggestion } from '@/lib/types/community';
import { Button } from '@/components/ui/Button';
import { Select } from '@/components/ui/Select';
import { Textarea } from '@/components/ui/Textarea';
import { CheckSquare, X, MessageSquare } from 'lucide-react';
import { toast } from 'react-toastify';

interface BulkSuggestionActionsProps {
  selectedSuggestions: CommunitySuggestion[];
  onActionComplete: () => void;
  onClearSelection: () => void;
}

export const BulkSuggestionActions = ({
  selectedSuggestions,
  onActionComplete,
  onClearSelection
}: BulkSuggestionActionsProps) => {
  const [action, setAction] = useState<string>('');
  const [bulkMessage, setBulkMessage] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);

  const handleBulkAction = async () => {
    if (!action || selectedSuggestions.length === 0) return;
    
    setIsProcessing(true);
    try {
      const response = await fetch('/api/admin/suggestions/bulk', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          suggestionIds: selectedSuggestions.map(s => s.id),
          action,
          message: bulkMessage
        })
      });
      
      if (response.ok) {
        toast.success(`Successfully updated ${selectedSuggestions.length} suggestions`);
        onActionComplete();
        onClearSelection();
        setAction('');
        setBulkMessage('');
      } else {
        throw new Error('Failed to process bulk action');
      }
    } catch (error) {
      toast.error('Failed to process bulk action');
    } finally {
      setIsProcessing(false);
    }
  };

  if (selectedSuggestions.length === 0) return null;

  return (
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <div className="flex items-center justify-between mb-4">
        <h3 className="font-medium text-blue-900">
          {selectedSuggestions.length} suggestion{selectedSuggestions.length > 1 ? 's' : ''} selected
        </h3>
        <Button
          variant="ghost"
          size="sm"
          onClick={onClearSelection}
          className="text-blue-600 hover:text-blue-800"
        >
          <X className="w-4 h-4" />
        </Button>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-blue-800 mb-2">
            Action
          </label>
          <Select
            value={action}
            onValueChange={setAction}
            placeholder="Select action"
          >
            <option value="approve">Approve</option>
            <option value="reject">Reject</option>
            <option value="needs_clarification">Needs Clarification</option>
            <option value="under_review">Mark Under Review</option>
          </Select>
        </div>
        
        <div className="md:col-span-2">
          <label className="block text-sm font-medium text-blue-800 mb-2">
            Message (optional)
          </label>
          <Textarea
            value={bulkMessage}
            onChange={(e) => setBulkMessage(e.target.value)}
            placeholder="Optional message to include in notifications..."
            rows={2}
            className="resize-none"
          />
        </div>
      </div>
      
      <div className="flex items-center justify-end mt-4 space-x-3">
        <Button
          variant="ghost"
          onClick={onClearSelection}
          disabled={isProcessing}
        >
          Cancel
        </Button>
        <Button
          onClick={handleBulkAction}
          disabled={!action || isProcessing}
          className="bg-blue-600 hover:bg-blue-700"
        >
          {isProcessing ? (
            <span className="flex items-center">
              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
              Processing...
            </span>
          ) : (
            <span className="flex items-center">
              <CheckSquare className="w-4 h-4 mr-2" />
              Apply to {selectedSuggestions.length} suggestion{selectedSuggestions.length > 1 ? 's' : ''}
            </span>
          )}
        </Button>
      </div>
    </div>
  );
};
```

### Notification System Enhancement

```typescript
// apps/web/lib/community/notifications.ts
import { CommunitySuggestion } from '@/lib/types/community';
import { sendEmail } from '@/lib/email';

export const SuggestionNotifications = {
  sendNewSuggestionAlert: async (suggestion: CommunitySuggestion) => {
    await sendEmail({
      to: process.env.ADMIN_EMAIL!,
      subject: `New Place Suggestion: ${suggestion.place_name}`,
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h2 style="color: #B85450;">New Community Suggestion</h2>
          <div style="background: #F8F6F0; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h3>${suggestion.place_name}</h3>
            <p><strong>Suggested by:</strong> ${suggestion.submitter_name} (${suggestion.submitter_email})</p>
            <p><strong>Category:</strong> ${suggestion.category}</p>
            <p><strong>Notes:</strong></p>
            <p>${suggestion.personal_notes}</p>
          </div>
          <div style="text-align: center; margin: 30px 0;">
            <a href="${process.env.NEXT_PUBLIC_SITE_URL}/admin/suggestions?id=${suggestion.id}" 
               style="background: #F4D03F; color: #000; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold;">
              Review Suggestion
            </a>
          </div>
        </div>
      `
    });
  },

  sendStatusUpdate: async (suggestion: CommunitySuggestion, newStatus: string, adminMessage?: string) => {
    const statusMessages = {
      under_review: {
        subject: `Your suggestion "${suggestion.place_name}" is under review`,
        message: `Hi ${suggestion.submitter_name},\n\nThank you for suggesting ${suggestion.place_name}! I'm currently reviewing your suggestion and will get back to you soon.`,
        color: '#F39C12'
      },
      approved: {
        subject: `Great news! "${suggestion.place_name}" has been approved`,
        message: `Hi ${suggestion.submitter_name},\n\nExciting news! Your suggestion for ${suggestion.place_name} has been approved and will be featured on the platform soon.`,
        color: '#27AE60'
      },
      published: {
        subject: `ðŸŽ‰ Your suggestion "${suggestion.place_name}" is now live!`,
        message: `Hi ${suggestion.submitter_name},\n\n${suggestion.place_name} is now live on the Indiranagar Discovery Platform! You'll be credited as the community contributor who discovered this gem.`,
        color: '#2D5016'
      },
      needs_clarification: {
        subject: `Question about your suggestion "${suggestion.place_name}"`,
        message: `Hi ${suggestion.submitter_name},\n\nI have a question about your suggestion for ${suggestion.place_name}. Could you provide some additional details?`,
        color: '#F39C12'
      },
      rejected: {
        subject: `Update on your suggestion "${suggestion.place_name}"`,
        message: `Hi ${suggestion.submitter_name},\n\nThank you for suggesting ${suggestion.place_name}. After review, this particular suggestion won't be featured at this time.`,
        color: '#E74C3C'
      }
    };

    const template = statusMessages[newStatus as keyof typeof statusMessages];
    if (!template) return;

    await sendEmail({
      to: suggestion.submitter_email,
      subject: template.subject,
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <div style="background: ${template.color}; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
            <h2 style="margin: 0;">${template.subject}</h2>
          </div>
          <div style="background: #F8F6F0; padding: 30px; border-radius: 0 0 8px 8px;">
            <p style="font-size: 16px; line-height: 1.6;">${template.message.replace(/\\n/g, '<br>')}</p>
            ${adminMessage ? `
              <div style="background: white; padding: 20px; border-radius: 6px; margin: 20px 0; border-left: 4px solid ${template.color};">
                <h4 style="margin-top: 0; color: ${template.color};">Personal Note from Amit:</h4>
                <p style="margin-bottom: 0;">${adminMessage}</p>
              </div>
            ` : ''}
            <div style="text-align: center; margin: 30px 0;">
              <a href="${process.env.NEXT_PUBLIC_SITE_URL}/suggest/track/${suggestion.id}" 
                 style="background: #F4D03F; color: #000; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold;">
                Track Suggestion
              </a>
            </div>
            <p style="font-size: 14px; color: #666; text-align: center; margin-top: 30px;">
              Thank you for helping build the Indiranagar community knowledge base!
            </p>
          </div>
        </div>
      `
    });
  },

  sendVoteNotification: async (suggestion: CommunitySuggestion) => {
    // Only send vote notifications for milestones (5, 10, 25, 50 votes)
    const milestones = [5, 10, 25, 50];
    if (!milestones.includes(suggestion.votes)) return;

    await sendEmail({
      to: suggestion.submitter_email,
      subject: `ðŸŽ‰ Your suggestion "${suggestion.place_name}" has ${suggestion.votes} votes!`,
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <div style="background: #2D5016; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
            <h2 style="margin: 0;">Community Support Growing!</h2>
          </div>
          <div style="background: #F8F6F0; padding: 30px; border-radius: 0 0 8px 8px; text-align: center;">
            <div style="background: #F4D03F; color: #000; border-radius: 50%; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 24px; font-weight: bold;">
              ${suggestion.votes}
            </div>
            <h3 style="color: #2D5016; margin: 0 0 10px;">${suggestion.place_name}</h3>
            <p style="font-size: 16px; margin: 0 0 20px;">has received <strong>${suggestion.votes} community votes</strong>!</p>
            <p style="color: #666; font-size: 14px;">The community is showing great interest in your suggestion. Higher vote counts help prioritize which places get reviewed first.</p>
          </div>
        </div>
      `
    });
  }
};
```

### Testing Implementation

```typescript
// apps/web/tests/components/community/CommunitySuggestionForm.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { vi } from 'vitest';
import { CommunitySuggestionForm } from '@/components/community/CommunitySuggestionForm';

// Mock dependencies
vi.mock('@/lib/community/suggestions', () => ({
  submitCommunitySuggestion: vi.fn()
}));

vi.mock('react-toastify', () => ({
  toast: {
    success: vi.fn(),
    error: vi.fn()
  }
}));

describe('CommunitySuggestionForm', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('renders all form fields correctly', () => {
    render(<CommunitySuggestionForm />);
    
    expect(screen.getByLabelText(/your name/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/email/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/place name/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/category/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/tell us about this place/i)).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /submit suggestion/i })).toBeInTheDocument();
  });

  it('validates required fields', async () => {
    render(<CommunitySuggestionForm />);
    
    const submitButton = screen.getByRole('button', { name: /submit suggestion/i });
    fireEvent.click(submitButton);
    
    // Form should not submit without required fields
    await waitFor(() => {
      expect(screen.getByLabelText(/your name/i)).toBeInvalid();
      expect(screen.getByLabelText(/email/i)).toBeInvalid();
      expect(screen.getByLabelText(/place name/i)).toBeInvalid();
    });
  });

  it('submits form with valid data', async () => {
    const mockSubmit = vi.mocked(await import('@/lib/community/suggestions')).submitCommunitySuggestion;
    mockSubmit.mockResolvedValue({ id: 'test-id', status: 'submitted' });
    
    render(<CommunitySuggestionForm />);
    
    // Fill out form
    fireEvent.change(screen.getByLabelText(/your name/i), {
      target: { value: 'John Doe' }
    });
    fireEvent.change(screen.getByLabelText(/email/i), {
      target: { value: 'john@example.com' }
    });
    fireEvent.change(screen.getByLabelText(/place name/i), {
      target: { value: 'Amazing Cafe' }
    });
    fireEvent.change(screen.getByLabelText(/category/i), {
      target: { value: 'cafe' }
    });
    fireEvent.change(screen.getByLabelText(/tell us about this place/i), {
      target: { value: 'Great coffee and atmosphere, perfect for work meetings.' }
    });
    
    // Submit form
    fireEvent.click(screen.getByRole('button', { name: /submit suggestion/i }));
    
    await waitFor(() => {
      expect(mockSubmit).toHaveBeenCalledWith(expect.objectContaining({
        submitter_name: 'John Doe',
        submitter_email: 'john@example.com',
        place_name: 'Amazing Cafe',
        category: 'cafe',
        personal_notes: 'Great coffee and atmosphere, perfect for work meetings.'
      }));
    });
  });

  it('handles submission errors gracefully', async () => {
    const mockSubmit = vi.mocked(await import('@/lib/community/suggestions')).submitCommunitySuggestion;
    mockSubmit.mockRejectedValue(new Error('Submission failed'));
    
    render(<CommunitySuggestionForm />);
    
    // Fill and submit form
    fireEvent.change(screen.getByLabelText(/your name/i), { target: { value: 'John Doe' } });
    fireEvent.change(screen.getByLabelText(/email/i), { target: { value: 'john@example.com' } });
    fireEvent.change(screen.getByLabelText(/place name/i), { target: { value: 'Test Place' } });
    fireEvent.change(screen.getByLabelText(/category/i), { target: { value: 'cafe' } });
    fireEvent.change(screen.getByLabelText(/tell us about this place/i), { target: { value: 'Test description' } });
    
    fireEvent.click(screen.getByRole('button', { name: /submit suggestion/i }));
    
    await waitFor(() => {
      expect(screen.getByText(/failed to submit suggestion/i)).toBeInTheDocument();
    });
  });
});
```

```typescript
// apps/web/tests/integration/community-suggestions.test.ts
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { createClient } from '@supabase/supabase-js';
import { submitCommunitySuggestion, getCommunitySuggestions } from '@/lib/community/suggestions';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

describe('Community Suggestions Integration', () => {
  let testSuggestionId: string;

  afterEach(async () => {
    // Clean up test data
    if (testSuggestionId) {
      await supabase
        .from('community_place_suggestions')
        .delete()
        .eq('id', testSuggestionId);
    }
  });

  it('should create and retrieve community suggestion', async () => {
    const suggestionData = {
      submitter_name: 'Test User',
      submitter_email: 'test@example.com',
      place_name: 'Test Place',
      suggested_latitude: 12.97,
      suggested_longitude: 77.59,
      category: 'cafe' as const,
      personal_notes: 'This is a test place suggestion'
    };

    // Create suggestion
    const createdSuggestion = await submitCommunitySuggestion(suggestionData);
    testSuggestionId = createdSuggestion.id;

    expect(createdSuggestion).toMatchObject({
      id: expect.any(String),
      status: 'submitted',
      ...suggestionData
    });

    // Retrieve suggestions
    const suggestions = await getCommunitySuggestions({ status: 'submitted' });
    const foundSuggestion = suggestions.find(s => s.id === testSuggestionId);
    
    expect(foundSuggestion).toBeTruthy();
    expect(foundSuggestion?.place_name).toBe('Test Place');
  });

  it('should handle voting system correctly', async () => {
    // Create test suggestion
    const suggestion = await submitCommunitySuggestion({
      submitter_name: 'Test User',
      submitter_email: 'test@example.com',
      place_name: 'Voting Test Place',
      suggested_latitude: 12.97,
      suggested_longitude: 77.59,
      category: 'restaurant',
      personal_notes: 'Testing voting functionality'
    });
    testSuggestionId = suggestion.id;

    // Vote for suggestion
    const { error } = await supabase
      .from('suggestion_votes')
      .insert({
        suggestion_id: suggestion.id,
        voter_fingerprint: 'test-fingerprint-1',
        ip_address: '127.0.0.1'
      });

    expect(error).toBeNull();

    // Check vote count updated
    const { data: updatedSuggestion } = await supabase
      .from('community_place_suggestions')
      .select('votes')
      .eq('id', suggestion.id)
      .single();

    expect(updatedSuggestion?.votes).toBe(1);
  });
});
```

### Mobile Optimization Features

```typescript
// apps/web/components/community/MobileSuggestionForm.tsx
import { useState } from 'react';
import { Camera, MapPin, Upload } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { useGeolocation } from '@/hooks/useGeolocation';

export const MobileSuggestionForm = () => {
  const [useCurrentLocation, setUseCurrentLocation] = useState(false);
  const { location, loading: locationLoading, error: locationError } = useGeolocation();
  const [photos, setPhotos] = useState<File[]>([]);

  const handlePhotoCapture = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    setPhotos(prev => [...prev, ...files].slice(0, 5)); // Max 5 photos
  };

  const getCurrentLocation = () => {
    setUseCurrentLocation(true);
  };

  return (
    <div className="mobile-suggestion-form max-w-md mx-auto p-4">
      {/* Location Helper */}
      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h3 className="font-medium text-blue-900 mb-2">Quick Location</h3>
        <Button
          type="button"
          variant="outline"
          size="sm"
          onClick={getCurrentLocation}
          disabled={locationLoading}
          className="w-full flex items-center justify-center"
        >
          <MapPin className="w-4 h-4 mr-2" />
          {locationLoading ? 'Getting location...' : 'Use Current Location'}
        </Button>
        {location && useCurrentLocation && (
          <p className="text-xs text-green-600 mt-2">
            âœ“ Location captured (within Indiranagar)
          </p>
        )}
      </div>

      {/* Photo Capture */}
      <div className="mb-6">
        <label className="block text-sm font-medium mb-2">Photos</label>
        <div className="space-y-3">
          <label className="flex items-center justify-center w-full p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-yellow-400 transition-colors">
            <input
              type="file"
              accept="image/*"
              capture="environment"
              multiple
              onChange={handlePhotoCapture}
              className="hidden"
            />
            <div className="text-center">
              <Camera className="w-8 h-8 text-gray-400 mx-auto mb-2" />
              <span className="text-sm text-gray-600">Take Photos</span>
            </div>
          </label>
          
          {photos.length > 0 && (
            <div className="grid grid-cols-3 gap-2">
              {photos.map((photo, index) => (
                <div key={index} className="relative">
                  <img
                    src={URL.createObjectURL(photo)}
                    alt={`Photo ${index + 1}`}
                    className="w-full h-20 object-cover rounded"
                  />
                  <button
                    type="button"
                    onClick={() => setPhotos(prev => prev.filter((_, i) => i !== index))}
                    className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"
                  >
                    Ã—
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Voice Notes (Future Enhancement) */}
      <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
        <h3 className="font-medium text-gray-700 mb-2">ðŸ’¡ Coming Soon</h3>
        <p className="text-sm text-gray-600">
          Voice notes for quick place descriptions while you're on the go!
        </p>
      </div>
    </div>
  );
};
```

## QA Results

Results from QA Agent QA review of the completed story implementation.